<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>2. CPU node 사용법(Python) | Chili Pepper</title>
<meta name="keywords" content="" />
<meta name="description" content="CPU node에서 Python 코드 실행하기 R 사용자는 Step 1-3을 숙지한 뒤 다음 문서로 넘어가세요.
Step 1 - terminal 앱 고르기 User는 SSH로 proxy node에 접속하여 클러스터를 사용합니다. 터미널 환경과 vi 에디터에 익숙한 user는 자신에게 친숙한 앱을 사용하면 됩니다. 그렇지 않은 경우 Visual Studio Code를 사용하는 것을 추천합니다. 이 문서에서는 Visual Studio Code를 사용하는 것을 전제로 합니다. 추천 이유는 다음과 같습니다.
 Windows, MacOS, Linux에서 모두 사용 가능합니다. 터미널과 에디터, 파일 브라우저가 통합되어 있습니다.">
<meta name="author" content="Jongmin Mun">
<link rel="canonical" href="https://hpc.stat.yonsei.ac.kr/docs/02_how-to-use-cpu-node_python/" />
<meta name="google-site-verification" content="XYZabc" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://hpc.stat.yonsei.ac.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://hpc.stat.yonsei.ac.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://hpc.stat.yonsei.ac.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://hpc.stat.yonsei.ac.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://hpc.stat.yonsei.ac.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.91.2" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="2. CPU node 사용법(Python)" />
<meta property="og:description" content="CPU node에서 Python 코드 실행하기 R 사용자는 Step 1-3을 숙지한 뒤 다음 문서로 넘어가세요.
Step 1 - terminal 앱 고르기 User는 SSH로 proxy node에 접속하여 클러스터를 사용합니다. 터미널 환경과 vi 에디터에 익숙한 user는 자신에게 친숙한 앱을 사용하면 됩니다. 그렇지 않은 경우 Visual Studio Code를 사용하는 것을 추천합니다. 이 문서에서는 Visual Studio Code를 사용하는 것을 전제로 합니다. 추천 이유는 다음과 같습니다.
 Windows, MacOS, Linux에서 모두 사용 가능합니다. 터미널과 에디터, 파일 브라우저가 통합되어 있습니다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hpc.stat.yonsei.ac.kr/docs/02_how-to-use-cpu-node_python/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2022-03-03T14:54:35&#43;09:00" />
<meta property="article:modified_time" content="2022-03-03T14:54:35&#43;09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="2. CPU node 사용법(Python)"/>
<meta name="twitter:description" content="CPU node에서 Python 코드 실행하기 R 사용자는 Step 1-3을 숙지한 뒤 다음 문서로 넘어가세요.
Step 1 - terminal 앱 고르기 User는 SSH로 proxy node에 접속하여 클러스터를 사용합니다. 터미널 환경과 vi 에디터에 익숙한 user는 자신에게 친숙한 앱을 사용하면 됩니다. 그렇지 않은 경우 Visual Studio Code를 사용하는 것을 추천합니다. 이 문서에서는 Visual Studio Code를 사용하는 것을 전제로 합니다. 추천 이유는 다음과 같습니다.
 Windows, MacOS, Linux에서 모두 사용 가능합니다. 터미널과 에디터, 파일 브라우저가 통합되어 있습니다."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Docs",
      "item": "https://hpc.stat.yonsei.ac.kr/docs/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "2. CPU node 사용법(Python)",
      "item": "https://hpc.stat.yonsei.ac.kr/docs/02_how-to-use-cpu-node_python/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "2. CPU node 사용법(Python)",
  "name": "2. CPU node 사용법(Python)",
  "description": "CPU node에서 Python 코드 실행하기 R 사용자는 Step 1-3을 숙지한 뒤 다음 문서로 넘어가세요.\nStep 1 - terminal 앱 고르기 User는 SSH로 proxy node에 접속하여 클러스터를 사용합니다. 터미널 환경과 vi 에디터에 익숙한 user는 자신에게 친숙한 앱을 사용하면 됩니다. 그렇지 않은 경우 Visual Studio Code를 사용하는 것을 추천합니다. 이 문서에서는 Visual Studio Code를 사용하는 것을 전제로 합니다. 추천 이유는 다음과 같습니다.\n Windows, MacOS, Linux에서 모두 사용 가능합니다. 터미널과 에디터, 파일 브라우저가 통합되어 있습니다.",
  "keywords": [
    
  ],
  "articleBody": "CPU node에서 Python 코드 실행하기 R 사용자는 Step 1-3을 숙지한 뒤 다음 문서로 넘어가세요.\nStep 1 - terminal 앱 고르기 User는 SSH로 proxy node에 접속하여 클러스터를 사용합니다. 터미널 환경과 vi 에디터에 익숙한 user는 자신에게 친숙한 앱을 사용하면 됩니다. 그렇지 않은 경우 Visual Studio Code를 사용하는 것을 추천합니다. 이 문서에서는 Visual Studio Code를 사용하는 것을 전제로 합니다. 추천 이유는 다음과 같습니다.\n Windows, MacOS, Linux에서 모두 사용 가능합니다. 터미널과 에디터, 파일 브라우저가 통합되어 있습니다.  불편하게 vi나 nano등의 CLI용 텍스트 에디터를 사용할 필요가 없습니다. 파일 전송시 scp등의 복잡한 프로토콜을 사용하지 않고 drag \u0026 drop으로 수행할 수 있습니다.    Visual Studio Code외에 다른 앱을 사용하실 경우 추천하는 앱은 다음과 같습니다.\n Windows 10: WSL2(Windows Subsystem for Linux 2)와 Windows Terminal을 설치하여 사용하는 것을 추천합니다. MacOS: 기본 터미널을 사용해도 되지만, iTerm2를 추천합니다. iOS: 5번 문서를 참조하세요. Android: Termux  proxy node  proxy node는 user가 로그인하여 파일을 정리하고 cpu-compute나 gpu-compute node에 job을 제출하는 용도로만 쓰는 컴퓨터입니다.  따라서 proxy node는 성능이 낮습니다. proxy node에서는 Python 작업 등을 실행하지 마세요.   터미널에서 SSH 접속만 할 수 있다면 어떤 기기에서도 proxy node에 접속하여 job을 제출할 수 있습니다. 일단 job을 제출하면, 터미널이 종료되고 user와 proxy node 간의 연결이 끊겨도 job은 계속 cpu-compute나 gpu-compute node에서 실행됩니다. Standard output(Python, R에서 console에 출력되는 메시지)이 로그 파일에 기록되므로, 나중에 다시 터미널에 접속하여 job 실행 현황을 확인할 수 있습니다.  Step 2 - proxy node SSH 접속 Visual Studio Code를 설치하고 아래 안내에 따라 설정합니다.\n1. Visual Studio Code extensions에서 Remote Development 설치1 Microsoft가 제공하는 Remote Development extension pack을 설치합니다. Remote-WSL, Remote-Containers, Remote-SSH가 자동적으로 같이 설치됩니다. 2. Remote Explorer에서 SSH Targets를 선택 후, Add New 클릭 3. ssh 접속 커맨드 입력 아래와 같은 창이 뜨면 SSH 커맨드를 입력하여 proxy node에 접속합니다. 아래 커맨드에 Slack으로 안내받은 port, username을 넣어서 위 창에 입력하고 Enter키를 누르면 됩니다. SSH의 default port는 22이지만, 저희는 보안상 이유로 다른 port를 사용합니다.\n1  ssh -p [port] [username]@hpc.stat.yonsei.ac.kr   또는 안내받은 proxy node의 ip를 입력해도 됩니다.\n1  ssh -p [port] [username]@[ip]   4. SSH configuration file을 저장할 장소 선택 Select SSH configuration file to update가 나오면 맨 위 항목을 선택합니다. Host added! 라는 메시지가 우측 하단에 나옵니다. 5. Remote Explore에서 Connect to Host in New Window 선택 6. 서버 Platform 선택 Linux를 선택합니다. 7. Password 입력 안내받은 password를 입력하여 로그인합니다. 8. 파일 시스템 마운트 좌측 탭의 파일 모양 아이콘을 클릭하고 Open Folder 버튼을 클릭합니다. 기본적으로 user home directory 경로가 입력되어 있습니다. OK를 누릅니다. 9. 둘러보기   좌측 file explorer에서 파일을 관리합니다. Windows 탐색기나 MacOS Finder에서 drag\u0026drop으로 파일을 옮길 수 있습니다. 클러스터 내부의 파일을 user의 local 컴퓨터로 가져오는 것도 drag\u0026drop으로 가능합니다.\n  ctrl + shift + ~키를 누르면 터미널이 열립니다. 여기서 서버 사용에 필요한 커맨드를 입력합니다. 터미널은 여러 개 띄울 수 있습니다.\n  text editor에서 코드와 스크립트를 수정하고 이미지 파일 등을 열람합니다.\n  10. user password 변경 모든 user의 초기 password가 다 동일하기 때문에, 각 user는 첫 접속 시 password를 변경할 것을 권장합니다. 터미널에서 아래 커맨드를 입력하여 password를 변경합니다.\n1  passwd   Step 3. 파일 시스템 구조 이해 NAS(Network Attached Storage)에 각 user의 home directory가 있습니다. NAS는 모든 node에 마운트되어 있으며, 모든 node에서 user명과 group명 및 관련 설정이 동일합니다. User명은 컴퓨팅 클러스터 사용 신청시 제출하신 이메일 주소의 @ 앞 부분과 동일합니다.\nUser home directory의 prefix는 /mnt/nas/users/입니다. 예를 들어, dummyuser라는 user의 home directory의 경로는 /mnt/nas/users/dummyuser/입니다. 다른 user의 home directory를 열람할 수 없도록 권한설정이 되어 있습니다. 각 user는 데이터와 코드, 설정 파일 등을 자신의 home directory 내에 저장합니다.\n Linux에서 directory를 이동하는 명령어는 cd입니다. home directory를 나타내는 기호는 ~입니다. 현재 directory를 확인하는 명령어는 pwd입니다 파일 목록을 확인하는 명령어는 ls입니다.  따라서 user는 proxy node아래의 명령어를 통해 자신의 홈 directory로 이동해 그 안에 있는 파일 목록을 확인할 수 있습니다.\n1 2  cd ~ ls   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  # with the tree command the home directory will typically look like this /mnt/nas/users/dummyuser/ ├── .bash_history ├── .bash_logout ├── .bashrc ├── .conda ├── .config ├── GettingStarted.md ├── .gnupg ├── .ipynb_checkpoints ├── .ipython ├── .jupyter ├── .local ├── logs ├── .npm ├── .profile ├── .python_history ├── some_script.sh ├── .ssh └── .viminfo   Step 4. Conda environment 생성  cpu-compute node에는 conda version 4.11.0이 설치되어 있으며 Python version을 3.10까지 지원합니다2. gpu-compute node에는 conda version 4.6.14가 설치되어 있으며 Python version을 3.8까지 지원합니다.  여기서는 cpu-compute node에서 conda environment를 생성하는 방법을 설명합니다. local에서 작성한 코드가 cpu-compute node에서 오류 없이 작동하도록 하기 위해, local과 cpu-compute node에서 동일한 conda environment를 구축해야 합니다.\n1. cpu-compute node에 conda environment 구축하기   Conda environment 생성 slurm batch script를 작성합니다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  #!/bin/bash #SBATCH --job-name=testEnv  #SBATCH --nodes=1 #SBATCH --time=99:59:59 #SBATCH --mem=4gb #SBATCH --partition=all #SBATCH --nodelist=cpu-compute #SBATCH --output=testEnv.log #SBATCH --error=testEnv.err CONDA_BIN_PATH=/opt/miniconda/bin ENV_NAME=testEnv ENV_PATH=/mnt/nas/users/$(whoami)/.conda/envs/$ENV_NAME #environment의 경 $CONDA_BIN_PATH/conda env remove --prefix $ENV_PATH #envenvironment가 이미 존재하면 삭제 $CONDA_BIN_PATH/conda create -y --prefix $ENV_PATH python=3.8.12 #파이썬 3.6버전으로 environment 생 source $CONDA_BIN_PATH/activate $ENV_PATH #conda를 환경변수에 등록하여 conda명령어만으로 conda가 실행되도록 함 conda install -y lightgbm scikit-learn pandas numpy #설치할 패키지 목록. -y는 yes/no question에 yes로 답하도록 함. 설치 중에 상호작용이 불가능하므로 -y 옵션이 꼭 필요함   위 내용에서\n 2번 라인의 #SBATCH –job-name=testEnv의 job name 7번 라인의 #SBATCH –output=testEnv.log의 output log 파일명 8번 라인의 #SBATCH –error=testEnv.err의 error log 파일명 10번 라인의 environment name 13번 라인의 python version 15번 라인의 패키지 설치 커맨드 를 알맞게 수정하여 Visual Studio Code에서 작성한 뒤, 클러스터 내 user home directory에 [your_env_name].job으로 저장합니다(e.g. testEnv.job).    작성한 스크립트 실행하기. Visual Studio Code 하단 터미널에\n1  sbatch [your_env_name].job   를 입력해 slurm batch job submission을 수행합니다. 작업이 노드에서 성공적으로 실행되면\n1  Submitted batch job 401   와 같은 메시지가 뜨고 job 번호가 할당됩니다. 할당되는 job 번호는 나중에 squeue를 통해 정보를 확인하거나 job을 취소할 때 이용되므로 기록해 놓아야 합니다.\n1  squeue   커맨드를 통해 작업 실행 현황을 확인할 수 있습니다.\n1 2  JOBID PARTITION NAME USER ST TIME NODES NODELIST(REASON) 402 all testEnv mjm R 0:01 1 cpu-compute   또는 아래 커맨드를 통해 실시간(1초 단위)으로 작업 실행 현황을 확인할 수 있습니다. ctrl+c로 escape 할 수 있습니다.\n1  smap -i 1   다음 커맨드를 통해 output log, error log파일의 내용을 확인할 수 있습니다.\n1 2  cat [your_job-name].log cat [your_job-name].err   log 파일의 내용을 다음 커맨드를 통해 실시간으로 확인할 수 있습니다. ctrl+c로 escape할 수 있습니다.\n1 2  tail -f [your_job_name].log tail -f [your_job_name].err   터미널을 여러 개 띄워 놓고 각각에 smap과 tail 커맨드를 입력하면 편리하게 실행 상황을 모니터링할 수 있습니다.\n위 샘플 코드는 약 3분 안에 작업이 완료됩니다. smap에서 작업 목록이 사라진 후 cat으로 로그 파일을 열어서\n1 2 3 4 5 6  pandas-1.1.3 | 10.5 MB | | 0% pandas-1.1.3 | 10.5 MB | #######1 | 71% pandas-1.1.3 | 10.5 MB | ########## | 100% Preparing transaction: ...working... done Verifying transaction: ...working... done Executing transaction: ...working... done   와 같은 기록이 남아 있으면 conda environment 생성이 완료된 것입니다.\n작업이 끝나기 전에 취소하려면 scancel 커맨드를 사용합니다.\n1  scancel [job_number]      가상환경을 생성한 후에 패키지를 추가로 설치할 때는 위의 job script에서 가상환경을 삭제하고 다시 만드는 부분\n1 2  CONDA_BIN_PATH/conda env remove --prefix ENV_PATH CONDA_BIN_PATH/conda create -y --prefix ENV_PATH python=3.8.12   을 삭제하고 아래와 같이 패키지를 설치하는 커맨드를 추가해 준 다음 job을 제출합니다. -y는 설치 중간에 yes/no 를 물을 경우 자동으로 yes를 입력하게 하는 옵션입니다. 설치 중에 컴퓨터를 직접 조작할 수 없기 때문에 꼭 사용해야 하는 옵션입니다. 아래는 pyyaml 패키지를 설치하는 job script 예시입니다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  ```bash #!/bin/bash #SBATCH --job-name=install_package #SBATCH --nodes=1 #SBATCH --time=99:59:59 #SBATCH --mem=4gb #SBATCH --partition=all #SBATCH --nodelist=cpu-compute #SBATCH --output=testEnv.log #SBATCH --error=testEnv.err CONDA_BIN_PATH=/opt/miniconda/bin ENV_NAME=testEnv ENV_PATH=/mnt/nas/users/$(whoami)/.conda/envs/$ENV_NAME #environment의 경 source $CONDA_BIN_PATH/activate $ENV_PATH conda install -y pyyaml #설치할 패키지 목록. -y는 yes/no question에 yes로 답하도록 함. 설치 중에 상호작용이 불가능하므로 -y 옵션이 꼭 필요함   가상환경 생성 및 패키지 설치 중 일어나는 오류 중 상당수가 Python에서 기본으로 제공하는 패키지를 설치하려 하거나, 설치할 패키지의 이름을 잘못 입력했기 때문에 발생합니다. 예를 들어, 위에서 설치한 pyyaml 패키지는 실제로 Python에서 import할 때는 import yaml로 입력하는데, conda install yaml이라고 job script에 쓸 경우 오류가 발생합니다.\nStep 5. Slrum batch script 작성하여 서버에 제출하기 5.1. Python 코드 작성 이제 클러스터에서 실행할 Python 코드를 local에서 작성합니다. 코드가 오류 없이 작동하는지 local에서 확인합니다. 그 후 코드 파일을 user home directory에 옮기거나, Visual Studio Code내에서 작성하여 저장합니다.\n아래는 tree 기반 boosting 알고리즘인 LightGBM으로 mnist dataset을 분류하는 코드입니다. Boosting round를 10회 수행하고 학습 결과를 csv파일로 저장합니다3. Batch script를 작성할 때는 알고리즘의 output이 자동으로 저장되지 않으므로 파일로 결과를 저장하는 코드를 포함하는 것이 좋습니다. 단, 콘솔에 출력되는 내용은 output log에 자동으로 기록됩니다. 아래 코드를 python_test_cpu.py로 저장하여 user home directory에 둡니다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59  import numpy as np from time import process_time from lightgbm import LGBMClassifier from sklearn.metrics import accuracy_score, log_loss from sklearn.datasets import fetch_openml from sklearn.model_selection import train_test_split def lgb(n=10, c=0, sequence=1): mnist = fetch_openml('mnist_784') x_train, x_test, y_train, y_test = train_test_split(mnist.data, mnist.target, test_size=0.33, random_state=42) proba_test = np.zeros((n, y_test.shape[0], len(np.unique(y_test)))) proba_train = np.zeros((n, y_train.shape[0], len(np.unique(y_train)))) test_score = [] train_score = [] tr_time = [] seq = [] while(n): model = LGBMClassifier(n_estimators=sequence) t0 = process_time() model.fit(x_train, y_train) tr_time.append(process_time() - t0) test_score.append(accuracy_score(y_test, model.predict(x_test))) train_score.append(accuracy_score(y_train, model.predict(x_train))) proba_test[c, ] = model.predict_proba(x_test) proba_train[c, ] = model.predict_proba(x_train) seq.append(sequence) sequence *= 2 n -= 1 c += 1 ce_train = [] ce_test = [] for i in range(10): ce_test.append(log_loss(y_test, proba_test[i])) ce_train.append(log_loss(y_train, proba_train[i])) np.savetxt('round'+ str(i) + 'proba_test.csv', proba_test[i]) np.savetxt('round'+ str(i) + 'proba_train.csv', proba_train[i]) np.savetxt('test_score.csv', test_score, delimiter=',') np.savetxt('train_score.csv', train_score, delimiter=',') np.savetxt('ce_test.csv', ce_test, delimiter=',') np.savetxt('ce_train.csv', ce_train, delimiter=',') if __name__ == '__main__': lgb()   5.2. 현재 클러스터 자원 사용량 확인 아래 커맨드를 통해 cpu-compute 노드의 cpu와 RAM 사용 현황을 볼 수 있습니다.\n1  sinfo -o \"%n %e %m %a %c %C\"   아래와 같은 결과가 나옵니다.\n1 2 3  HOSTNAMES FREE_MEM MEMORY AVAIL CPUS CPUS(A/I/O/T) cpu-compute 105589 128916 up 32 0/32/0/32 gpu-compute 53318 80532 up 16 0/16/0/16    CPUS의 A/I/O/T는 allocated/idle/other/total을 의미합니다. 자신의 job이 바로 실행되기를 원한다면, Slurm batch script를 작성할 때  RAM 용량을 FREE_MEM보다 적게 설정해야 합니다. CPU 코어 개수를 CPUS idle보다 적게 설정해야 합니다.   현재 가용 자원보다 더 많은 자원을 요구하는 script를 작성하면, job이 바로 실행되지 않습니다. 대기 상태에 있다가 다른 user들의 job이 끝나고 자원이 반환되면 job이 실행됩니다.  5.3. Slurm batch script 작성 앞선 단계에서 만든 해당 conda environment를 activate하고 코드를 실행하는 Slurm batch script를 작성합니다. 클러스터 소개 페이지의 slurm job configurator를 사용하면 script를 쉽게 작성할 수 있습니다.\n Conda activate에 체크합니다. 빈칸들을 채웁니다. 사용 시간을 넉넉하게 입력할 것을 권장합니다. Script란에 python xxx.py라고 작성합니다. 이는 home directory에 있는 xxx.py 파일을 Python으로 실행하라는 의미입니다. Job script를 작성하거나 sbatch 명령어를 사용할 때, visual studio code의 explorer에서 파일명을 마우스 우클릭하고 경로 복사를 사용하면 편리합니다. Print \u0026 Copy 버튼을 누르면 내용이 클립보드에 복사됩니다.  Slurm batch script의 내용은 아래와 같습니다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  #!/bin/bash # #SBATCH --job-name=python_test_cpu #SBATCH --partition=all #SBATCH --account=mjm #SBATCH --mem=4gb #SBATCH --ntasks=1 #SBATCH --cpus-per-task=4 #SBATCH --time=01:00:00 #SBATCH --output=/mnt/nas/users/mjm/python_test_cpu.log #SBATCH --error=/mnt/nas/users/mjm/python_test_cpu.err #SBATCH --nodelist=cpu-compute CONDA_BIN_PATH=/opt/miniconda/bin ENV_NAME=testEnv ENV_PATH=/mnt/nas/users/$(whoami)/.conda/envs/$ENV_NAME source $CONDA_BIN_PATH/activate $ENV_PATH python python_test_cpu.py   python_test_cpu.job이라는 이름으로 클러스터의 user home directory에 저장합니다.\nScript 윗부분의 #SBATCH 옵션들의 의미는 다음과 같습니다.\n —job-name: 수행할 작업의 이름 —mem: memory limit —nodelist: 작업할 노드의 이름 —ntasks: 작업의 수 —cpus-per-task: 각 작업에서 사용할 cpu 코어의 수 —time: 작업 제한시간 —account: 해당 작업을 수행하는 계정의 이름 —partition: group of nodes with specific characteristics –nodelist: 사용할 node의 이름 —output: 코드 실행 결과 log 파일. 확장자는 out이나 log가 가능합니다. —error: 코드 실행 결과 log error 파일과 log 파일의 파일명과 저장 경로는 원하는 데로 수정할 수 있습니다. sbatch에 대한 더 자세한 정보는 Slurm 공식 웹페이지를 참조하세요.  5.4. Slurm batch script 실행 Conda environment를 만들 때처럼, sbatch 커맨드를 통해 job을 제출합니다. 할당되는 job 번호는 나중에 squeue를 통해 정보를 확인하거나 job을 취소할 때 이용되므로 기록해 놓아야 합니다.\nStep 4에서처럼, ctrl+shift+~를 눌러 터미널을 여러 개 띄우고 smap -i로 작업 현황을 확인하고, tail -f xxx.out, tail -f xxx.err으로 콘솔 출력이나 error를 확인합니다. 작업은 4분 정도 걸립니다.\n1  sbatch python_test_cpu.job   현재 작업이 자원을 얼마나 할당받았는지 확인하려면 다음 커맨드를 사용합니다. NumCPUs=4가 코어를 4개 할당받았다는 뜻이고, mem=4G가 RAM을 4gb 할당받았다는 뜻입니다. 이 커맨드는 다른 user가 제출한 job에 대해서도 사용할 수 있습니다.\n1  scontrol show job [job number]   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  UserId=mjm(1003) GroupId=mjm(1003) MCS_label=N/A Priority=4294901694 Nice=0 Account=mjm QOS=(null) JobState=RUNNING Reason=None Dependency=(null) Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0 RunTime=00:00:05 TimeLimit=01:00:00 TimeMin=N/A SubmitTime=2022-03-17T15:31:01 EligibleTime=2022-03-17T15:31:01 StartTime=2022-03-17T15:31:01 EndTime=2022-03-17T16:31:01 Deadline=N/A PreemptTime=None SuspendTime=None SecsPreSuspend=0 LastSchedEval=2022-03-17T15:31:01 Partition=all AllocNode:Sid=proxy:30897 ReqNodeList=cpu-compute ExcNodeList=(null) NodeList=cpu-compute BatchHost=cpu-compute NumNodes=1 NumCPUs=4 NumTasks=1 CPUs/Task=4 ReqB:S:C:T=0:0:*:* TRES=cpu=4,mem=4G,node=1,billing=4 Socks/Node=* NtasksPerN:B:S:C=0:0:*:* CoreSpec=* MinCPUsNode=4 MinMemoryNode=4G MinTmpDiskNode=0 Features=(null) DelayBoot=00:00:00 Gres=(null) Reservation=(null) OverSubscribe=OK Contiguous=0 Licenses=(null) Network=(null) Command=/mnt/nas/users/mjm/python_test_cpu.job WorkDir=/mnt/nas/users/mjm StdErr=/mnt/nas/users/mjm/python_test_cpu.err StdIn=/dev/null StdOut=/mnt/nas/users/mjm/python_test_cpu.log Power=   Visual Stuio Code의 file explorer는 실시간으로 변화가 반영되지 않습니다. 새로고침 버튼을 눌러 주면 변화가 반영되고 output 파일이 explorer에 보입니다.\n더 알아보기 Submitting a slurm job script\nSLRUM Job Examples\nReferences   https://jstar0525.tistory.com/14 ↩︎\n https://docs.conda.io/projects/conda/en/latest/release-notes.html ↩︎\n https://www.kaggle.com/samanemami/script-lightgbm-mnist ↩︎\n   ",
  "wordCount" : "2096",
  "inLanguage": "en",
  "datePublished": "2022-03-03T14:54:35+09:00",
  "dateModified": "2022-03-03T14:54:35+09:00",
  "author":{
    "@type": "Person",
    "name": "Jongmin Mun"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://hpc.stat.yonsei.ac.kr/docs/02_how-to-use-cpu-node_python/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chili Pepper",
    "logo": {
      "@type": "ImageObject",
      "url": "https://hpc.stat.yonsei.ac.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://hpc.stat.yonsei.ac.kr" accesskey="h" title="Chili Pepper (Alt + H)">Chili Pepper</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://hpc.stat.yonsei.ac.kr/docs/" title="Docs">
                    <span>Docs</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://hpc.stat.yonsei.ac.kr">Home</a>&nbsp;»&nbsp;<a href="https://hpc.stat.yonsei.ac.kr/docs/">Docs</a></div>
    <h1 class="post-title">
      2. CPU node 사용법(Python)
    </h1>
    <div class="post-meta"><span title='2022-03-03 14:54:35 +0900 +0900'>March 3, 2022</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Jongmin Mun

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#cpu-node%ec%97%90%ec%84%9c-python-%ec%bd%94%eb%93%9c-%ec%8b%a4%ed%96%89%ed%95%98%ea%b8%b0" aria-label="CPU node에서 Python 코드 실행하기">CPU node에서 Python 코드 실행하기</a><ul>
                        
                <li>
                    <a href="#step-1---terminal-%ec%95%b1-%ea%b3%a0%eb%a5%b4%ea%b8%b0" aria-label="Step 1 - terminal 앱 고르기">Step 1 - terminal 앱 고르기</a><ul>
                        
                <li>
                    <a href="#proxy-node" aria-label="proxy node">proxy node</a></li></ul>
                </li>
                <li>
                    <a href="#step-2---proxy-node-ssh-%ec%a0%91%ec%86%8d" aria-label="Step 2 - proxy node SSH 접속">Step 2 - proxy node SSH 접속</a><ul>
                        
                <li>
                    <a href="#1-visual-studio-code-extensions%ec%97%90%ec%84%9c-remote-development-%ec%84%a4%ec%b9%98fn3" aria-label="1. Visual Studio Code extensions에서 Remote Development 설치1">1. Visual Studio Code extensions에서 Remote Development 설치<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></a></li>
                <li>
                    <a href="#2-remote-explorer%ec%97%90%ec%84%9c-ssh-targets%eb%a5%bc-%ec%84%a0%ed%83%9d-%ed%9b%84-add-new-%ed%81%b4%eb%a6%ad" aria-label="2. Remote Explorer에서 SSH Targets를 선택 후, Add New 클릭">2. Remote Explorer에서 SSH Targets를 선택 후, Add New 클릭</a></li>
                <li>
                    <a href="#3-ssh-%ec%a0%91%ec%86%8d-%ec%bb%a4%eb%a7%a8%eb%93%9c-%ec%9e%85%eb%a0%a5" aria-label="3. ssh 접속 커맨드 입력">3. ssh 접속 커맨드 입력</a></li>
                <li>
                    <a href="#4-ssh-configuration-file%ec%9d%84-%ec%a0%80%ec%9e%a5%ed%95%a0-%ec%9e%a5%ec%86%8c-%ec%84%a0%ed%83%9d" aria-label="4. SSH configuration file을 저장할 장소 선택">4. SSH configuration file을 저장할 장소 선택</a></li>
                <li>
                    <a href="#5-remote-explore%ec%97%90%ec%84%9c-connect-to-host-in-new-window-%ec%84%a0%ed%83%9d" aria-label="5. Remote Explore에서 Connect to Host in New Window 선택">5. Remote Explore에서 Connect to Host in New Window 선택</a></li>
                <li>
                    <a href="#6-%ec%84%9c%eb%b2%84-platform-%ec%84%a0%ed%83%9d" aria-label="6. 서버 Platform 선택">6. 서버 Platform 선택</a></li>
                <li>
                    <a href="#7-password-%ec%9e%85%eb%a0%a5" aria-label="7. Password 입력">7. Password 입력</a></li>
                <li>
                    <a href="#8-%ed%8c%8c%ec%9d%bc-%ec%8b%9c%ec%8a%a4%ed%85%9c-%eb%a7%88%ec%9a%b4%ed%8a%b8" aria-label="8. 파일 시스템 마운트">8. 파일 시스템 마운트</a></li>
                <li>
                    <a href="#9-%eb%91%98%eb%9f%ac%eb%b3%b4%ea%b8%b0" aria-label="9. 둘러보기">9. 둘러보기</a></li>
                <li>
                    <a href="#10-user-password-%eb%b3%80%ea%b2%bd" aria-label="10. user password 변경">10. user password 변경</a></li></ul>
                </li>
                <li>
                    <a href="#step-3-%ed%8c%8c%ec%9d%bc-%ec%8b%9c%ec%8a%a4%ed%85%9c-%ea%b5%ac%ec%a1%b0-%ec%9d%b4%ed%95%b4" aria-label="Step 3. 파일 시스템 구조 이해">Step 3. 파일 시스템 구조 이해</a></li>
                <li>
                    <a href="#step-4-conda-environment-%ec%83%9d%ec%84%b1" aria-label="Step 4. Conda environment 생성">Step 4. Conda environment 생성</a><ul>
                        
                <li>
                    <a href="#1-cpu-compute-node%ec%97%90-conda-environment-%ea%b5%ac%ec%b6%95%ed%95%98%ea%b8%b0" aria-label="1. cpu-compute node에 conda environment 구축하기">1. <code>cpu-compute</code> node에 conda environment 구축하기</a></li></ul>
                </li>
                <li>
                    <a href="#step-5-slrum-batch-script-%ec%9e%91%ec%84%b1%ed%95%98%ec%97%ac-%ec%84%9c%eb%b2%84%ec%97%90-%ec%a0%9c%ec%b6%9c%ed%95%98%ea%b8%b0" aria-label="Step 5. Slrum batch script 작성하여 서버에 제출하기">Step 5. Slrum batch script 작성하여 서버에 제출하기</a><ul>
                        
                <li>
                    <a href="#51-python-%ec%bd%94%eb%93%9c-%ec%9e%91%ec%84%b1" aria-label="5.1. Python 코드 작성">5.1. Python 코드 작성</a></li>
                <li>
                    <a href="#52-%ed%98%84%ec%9e%ac-%ed%81%b4%eb%9f%ac%ec%8a%a4%ed%84%b0-%ec%9e%90%ec%9b%90-%ec%82%ac%ec%9a%a9%eb%9f%89-%ed%99%95%ec%9d%b8" aria-label="5.2. 현재 클러스터 자원 사용량 확인">5.2. 현재 클러스터 자원 사용량 확인</a></li>
                <li>
                    <a href="#53-slurm-batch-script-%ec%9e%91%ec%84%b1" aria-label="5.3. Slurm batch script 작성">5.3. Slurm batch script 작성</a></li>
                <li>
                    <a href="#54-slurm-batch-script-%ec%8b%a4%ed%96%89" aria-label="5.4. Slurm batch script 실행">5.4. Slurm batch script 실행</a></li></ul>
                </li>
                <li>
                    <a href="#%eb%8d%94-%ec%95%8c%ec%95%84%eb%b3%b4%ea%b8%b0" aria-label="더 알아보기">더 알아보기</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="cpu-node에서-python-코드-실행하기">CPU node에서 Python 코드 실행하기<a hidden class="anchor" aria-hidden="true" href="#cpu-node에서-python-코드-실행하기">#</a></h1>
<p>R 사용자는 Step 1-3을 숙지한 뒤 다음 문서로 넘어가세요.</p>
<h2 id="step-1---terminal-앱-고르기">Step 1 - terminal 앱 고르기<a hidden class="anchor" aria-hidden="true" href="#step-1---terminal-앱-고르기">#</a></h2>
<p>User는 <code>SSH</code>로 <code>proxy</code> node에 접속하여 클러스터를 사용합니다. 터미널 환경과 <code>vi</code> 에디터에 익숙한 user는 자신에게 친숙한 앱을 사용하면 됩니다. 그렇지 않은 경우 <a href="https://code.visualstudio.com/download"><code>Visual Studio Code</code></a>를 사용하는 것을 추천합니다. 이 문서에서는 <code>Visual Studio Code</code>를 사용하는 것을 전제로 합니다. 추천 이유는 다음과 같습니다.</p>
<ul>
<li>Windows, MacOS, Linux에서 모두 사용 가능합니다.</li>
<li>터미널과 에디터, 파일 브라우저가 통합되어 있습니다.
<ul>
<li>불편하게 <code>vi</code>나 <code>nano</code>등의 CLI용 텍스트 에디터를 사용할 필요가 없습니다.</li>
<li>파일 전송시 <code>scp</code>등의 복잡한 프로토콜을 사용하지 않고 drag &amp; drop으로 수행할 수 있습니다.</li>
</ul>
</li>
</ul>
<p><code>Visual Studio Code</code>외에 다른 앱을 사용하실 경우 추천하는 앱은 다음과 같습니다.</p>
<ul>
<li>Windows 10: <a href="https://docs.microsoft.com/ko-kr/windows/wsl/install">WSL2(Windows Subsystem for Linux 2)</a>와 <a href="(https://docs.microsoft.com/ko-kr/windows/terminal/install)">Windows Terminal</a>을 설치하여 사용하는 것을 추천합니다.</li>
<li>MacOS: 기본 터미널을 사용해도 되지만, <a href="https://iterm2.com">iTerm2</a>를 추천합니다.</li>
<li>iOS: <a href="https://hpc.stat.yonsei.ac.kr/docs/05_ipad">5번 문서</a>를 참조하세요.</li>
<li>Android: <a href="https://play.google.com/store/apps/details?id=com.termux&amp;hl=ko&amp;gl=US">Termux</a></li>
</ul>
<h3 id="proxy-node">proxy node<a hidden class="anchor" aria-hidden="true" href="#proxy-node">#</a></h3>
<ul>
<li><code>proxy</code> node는 user가 로그인하여 파일을 정리하고 <code>cpu-compute</code>나 <code>gpu-compute</code> node에 job을 제출하는 용도로만 쓰는 컴퓨터입니다.
<ul>
<li>따라서 <code>proxy</code> node는 성능이 낮습니다. <code>proxy</code> node에서는 Python 작업 등을 실행하지 마세요.</li>
</ul>
</li>
<li>터미널에서 <code>SSH</code> 접속만 할 수 있다면 어떤 기기에서도 <code>proxy</code> node에 접속하여 job을 제출할 수 있습니다.</li>
<li>일단 job을 제출하면, 터미널이 종료되고 user와 <code>proxy</code> node 간의 연결이 끊겨도 job은 계속 <code>cpu-compute</code>나 <code>gpu-compute</code> node에서 실행됩니다.</li>
<li>Standard output(Python, R에서 console에 출력되는 메시지)이 로그 파일에 기록되므로, 나중에 다시 터미널에 접속하여 job 실행 현황을 확인할 수 있습니다.</li>
</ul>
<h2 id="step-2---proxy-node-ssh-접속">Step 2 - proxy node SSH 접속<a hidden class="anchor" aria-hidden="true" href="#step-2---proxy-node-ssh-접속">#</a></h2>
<p><a href="https://code.visualstudio.com/download">Visual Studio Code</a>를 설치하고 아래 안내에 따라 설정합니다.</p>
<h3 id="1-visual-studio-code-extensions에서-remote-development-설치fn3">1. Visual Studio Code extensions에서 Remote Development 설치<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><a hidden class="anchor" aria-hidden="true" href="#1-visual-studio-code-extensions에서-remote-development-설치fn3">#</a></h3>
<p>Microsoft가 제공하는 <code>Remote Development</code> extension pack을 설치합니다. Remote-WSL, Remote-Containers, Remote-SSH가 자동적으로 같이 설치됩니다.
<img loading="lazy" src="/img/vscode_ssh_1.png" alt="vscode_ssh_1"  />

<img loading="lazy" src="/img/vscode_ssh_2.png" alt="vscode_ssh_2"  />
</p>
<h3 id="2-remote-explorer에서-ssh-targets를-선택-후-add-new-클릭">2. Remote Explorer에서 SSH Targets를 선택 후, Add New 클릭<a hidden class="anchor" aria-hidden="true" href="#2-remote-explorer에서-ssh-targets를-선택-후-add-new-클릭">#</a></h3>
<p><img loading="lazy" src="/img/vscode_ssh_3.png" alt="vscode_ssh_3"  />
</p>
<h3 id="3-ssh-접속-커맨드-입력">3. ssh 접속 커맨드 입력<a hidden class="anchor" aria-hidden="true" href="#3-ssh-접속-커맨드-입력">#</a></h3>
<p>아래와 같은 창이 뜨면 <code>SSH</code> 커맨드를 입력하여 <code>proxy node</code>에 접속합니다.
<img loading="lazy" src="/img/vscode_ssh_4.png" alt="vscode_ssh_4"  />
</p>
<p>아래 커맨드에 Slack으로 안내받은 port, username을 넣어서 위 창에 입력하고 <code>Enter</code>키를 누르면 됩니다. <code>SSH</code>의 default port는 <code>22</code>이지만, 저희는 보안상 이유로 다른 port를 사용합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">ssh -p <span class="o">[</span>port<span class="o">]</span> <span class="o">[</span>username<span class="o">]</span>@hpc.stat.yonsei.ac.kr 
</code></pre></td></tr></table>
</div>
</div><p>또는 안내받은 proxy node의 ip를 입력해도 됩니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">ssh -p <span class="o">[</span>port<span class="o">]</span> <span class="o">[</span>username<span class="o">]</span>@<span class="o">[</span>ip<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="4-ssh-configuration-file을-저장할-장소-선택">4. SSH configuration file을 저장할 장소 선택<a hidden class="anchor" aria-hidden="true" href="#4-ssh-configuration-file을-저장할-장소-선택">#</a></h3>
<p><strong>Select SSH configuration file to update</strong>가 나오면 맨 위 항목을 선택합니다.
<img loading="lazy" src="/img/vscode_ssh_5.png" alt="vscode_ssh_5"  />
</p>
<p><strong>Host added!</strong> 라는 메시지가 우측 하단에 나옵니다.
<img loading="lazy" src="/img/vscode_ssh_6.png" alt="vscode_ssh_6"  />
</p>
<h3 id="5-remote-explore에서-connect-to-host-in-new-window-선택">5. Remote Explore에서 Connect to Host in New Window 선택<a hidden class="anchor" aria-hidden="true" href="#5-remote-explore에서-connect-to-host-in-new-window-선택">#</a></h3>
<p><img loading="lazy" src="/img/vscode_ssh_7.png" alt="vscode_ssh_7"  />
</p>
<h3 id="6-서버-platform-선택">6. 서버 Platform 선택<a hidden class="anchor" aria-hidden="true" href="#6-서버-platform-선택">#</a></h3>
<p>Linux를 선택합니다.
<img loading="lazy" src="/img/vscode_ssh_8.png" alt="vscode_ssh_8"  />
</p>
<h3 id="7-password-입력">7. Password 입력<a hidden class="anchor" aria-hidden="true" href="#7-password-입력">#</a></h3>
<p>안내받은 password를 입력하여 로그인합니다.
<img loading="lazy" src="/img/vscode_ssh_9.png" alt="vscode_ssh_9"  />
</p>
<h3 id="8-파일-시스템-마운트">8. 파일 시스템 마운트<a hidden class="anchor" aria-hidden="true" href="#8-파일-시스템-마운트">#</a></h3>
<p>좌측 탭의 파일 모양 아이콘을 클릭하고 <strong>Open Folder</strong> 버튼을 클릭합니다.
<img loading="lazy" src="/img/vscode_ssh_10.png" alt="vscode_ssh_10"  />
</p>
<p>기본적으로 user home directory 경로가 입력되어 있습니다. OK를 누릅니다.
<img loading="lazy" src="/img/vscode_ssh_11.png" alt="vscode_ssh_11"  />
</p>
<h3 id="9-둘러보기">9. 둘러보기<a hidden class="anchor" aria-hidden="true" href="#9-둘러보기">#</a></h3>
<p><img loading="lazy" src="/img/vscode_ssh_12.png" alt="vscode_ssh_12"  />
</p>
<ul>
<li>
<p>좌측 file explorer에서 파일을 관리합니다. Windows 탐색기나 MacOS Finder에서 drag&amp;drop으로 파일을 옮길 수 있습니다. 클러스터 내부의 파일을 user의 local 컴퓨터로 가져오는 것도 drag&amp;drop으로 가능합니다.</p>
</li>
<li>
<p><code>ctrl + shift + ~</code>키를 누르면 터미널이 열립니다. 여기서 서버 사용에 필요한 커맨드를 입력합니다. 터미널은 여러 개 띄울 수 있습니다.</p>
</li>
<li>
<p>text editor에서 코드와 스크립트를 수정하고 이미지 파일 등을 열람합니다.</p>
</li>
</ul>
<h3 id="10-user-password-변경">10. user password 변경<a hidden class="anchor" aria-hidden="true" href="#10-user-password-변경">#</a></h3>
<p>모든 user의 초기 password가 다 동일하기 때문에, 각 user는 첫 접속 시 password를 변경할 것을 권장합니다. 터미널에서 아래 커맨드를 입력하여 password를 변경합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">passwd
</code></pre></td></tr></table>
</div>
</div><h2 id="step-3-파일-시스템-구조-이해">Step 3. 파일 시스템 구조 이해<a hidden class="anchor" aria-hidden="true" href="#step-3-파일-시스템-구조-이해">#</a></h2>
<p>NAS(Network Attached Storage)에 각 user의 home directory가 있습니다. NAS는 모든 node에 마운트되어 있으며, 모든 node에서 user명과 group명 및 관련 설정이 동일합니다. User명은 컴퓨팅 클러스터 사용 신청시 제출하신 이메일 주소의 @ 앞 부분과 동일합니다.</p>
<p>User home directory의 prefix는 <code>/mnt/nas/users/</code>입니다. 예를 들어, <code>dummyuser</code>라는 user의 home directory의 경로는 <code>/mnt/nas/users/dummyuser/</code>입니다. 다른 user의 home directory를 열람할 수 없도록 권한설정이 되어 있습니다. 각 user는 데이터와 코드, 설정 파일 등을 자신의 home directory 내에 저장합니다.</p>
<ul>
<li>Linux에서 directory를 이동하는 명령어는 <code>cd</code>입니다.</li>
<li>home directory를 나타내는 기호는 <code>~</code>입니다.</li>
<li>현재 directory를 확인하는 명령어는 <code>pwd</code>입니다</li>
<li>파일 목록을 확인하는 명령어는 <code>ls</code>입니다.</li>
</ul>
<p>따라서 user는 proxy node아래의 명령어를 통해 자신의 홈 directory로 이동해 그 안에 있는 파일 목록을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">cd ~
ls
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span><span class="lnt" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a>
</span><span class="lnt" id="17"><a style="outline: none; text-decoration:none; color:inherit" href="#17">17</a>
</span><span class="lnt" id="18"><a style="outline: none; text-decoration:none; color:inherit" href="#18">18</a>
</span><span class="lnt" id="19"><a style="outline: none; text-decoration:none; color:inherit" href="#19">19</a>
</span><span class="lnt" id="20"><a style="outline: none; text-decoration:none; color:inherit" href="#20">20</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"># with the tree command the home directory will typically look like this
/mnt/nas/users/dummyuser/
├── .bash_history
├── .bash_logout
├── .bashrc
├── .conda
├── .config
├── GettingStarted.md
├── .gnupg
├── .ipynb_checkpoints
├── .ipython
├── .jupyter
├── .local
├── logs
├── .npm
├── .profile
├── .python_history
├── some_script.sh
├── .ssh
└── .viminfo
</code></pre></td></tr></table>
</div>
</div><h2 id="step-4-conda-environment-생성">Step 4. Conda environment 생성<a hidden class="anchor" aria-hidden="true" href="#step-4-conda-environment-생성">#</a></h2>
<ul>
<li><code>cpu-compute</code> node에는 conda version 4.11.0이 설치되어 있으며 Python version을 3.10까지 지원합니다<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</li>
<li><code>gpu-compute</code> node에는 conda version 4.6.14가 설치되어 있으며 Python version을 3.8까지 지원합니다.</li>
</ul>
<p>여기서는 <code>cpu-compute</code> node에서 conda environment를 생성하는 방법을 설명합니다. local에서 작성한 코드가 <code>cpu-compute</code> node에서 오류 없이 작동하도록 하기 위해, local과 <code>cpu-compute</code> node에서 동일한 conda environment를 구축해야 합니다.</p>
<h3 id="1-cpu-compute-node에-conda-environment-구축하기">1. <code>cpu-compute</code> node에 conda environment 구축하기<a hidden class="anchor" aria-hidden="true" href="#1-cpu-compute-node에-conda-environment-구축하기">#</a></h3>
<ol>
<li>
<p>Conda environment 생성 slurm batch script를 작성합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span><span class="lnt" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="c1">#SBATCH --job-name=testEnv </span>
<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --time=99:59:59</span>
<span class="c1">#SBATCH --mem=4gb</span>
<span class="c1">#SBATCH --partition=all</span>
<span class="c1">#SBATCH --nodelist=cpu-compute</span>
<span class="c1">#SBATCH --output=testEnv.log</span>
<span class="c1">#SBATCH --error=testEnv.err</span>
<span class="nv">CONDA_BIN_PATH</span><span class="o">=</span>/opt/miniconda/bin
<span class="nv">ENV_NAME</span><span class="o">=</span>testEnv 
<span class="nv">ENV_PATH</span><span class="o">=</span>/mnt/nas/users/<span class="k">$(</span>whoami<span class="k">)</span>/.conda/envs/<span class="nv">$ENV_NAME</span> <span class="c1">#environment의 경</span>
<span class="nv">$CONDA_BIN_PATH</span>/conda env remove --prefix <span class="nv">$ENV_PATH</span> <span class="c1">#envenvironment가 이미 존재하면 삭제</span>
<span class="nv">$CONDA_BIN_PATH</span>/conda create -y --prefix <span class="nv">$ENV_PATH</span> <span class="nv">python</span><span class="o">=</span>3.8.12 <span class="c1">#파이썬 3.6버전으로 environment 생</span>
<span class="nb">source</span> <span class="nv">$CONDA_BIN_PATH</span>/activate <span class="nv">$ENV_PATH</span> <span class="c1">#conda를 환경변수에 등록하여 conda명령어만으로 conda가 실행되도록 함</span>
conda install -y lightgbm scikit-learn pandas numpy <span class="c1">#설치할 패키지 목록. -y는 yes/no question에 yes로 답하도록 함. 설치 중에 상호작용이 불가능하므로 -y 옵션이 꼭 필요함</span>
</code></pre></td></tr></table>
</div>
</div><p>위 내용에서</p>
<ul>
<li>2번 라인의 <strong>#SBATCH &ndash;job-name=testEnv</strong>의 job name</li>
<li>7번 라인의 <strong>#SBATCH &ndash;output=testEnv.log</strong>의 output log 파일명</li>
<li>8번 라인의 <strong>#SBATCH &ndash;error=testEnv.err</strong>의 error log 파일명</li>
<li>10번 라인의 environment name</li>
<li>13번 라인의 python version</li>
<li>15번 라인의 패키지 설치 커맨드
를 알맞게 수정하여 <code>Visual Studio Code</code>에서 작성한 뒤, 클러스터 내 user home directory에 <code>[your_env_name].job</code>으로 저장합니다(e.g.  <code>testEnv.job</code>).</li>
</ul>
</li>
<li>
<p>작성한 스크립트 실행하기. <code>Visual Studio Code</code> 하단 터미널에</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sbatch <span class="o">[</span>your_env_name<span class="o">]</span>.job
</code></pre></td></tr></table>
</div>
</div><p>를 입력해 slurm batch job submission을 수행합니다. 작업이 노드에서 성공적으로 실행되면</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Submitted batch job 401
</code></pre></td></tr></table>
</div>
</div><p>와 같은 메시지가 뜨고 job 번호가 할당됩니다. 할당되는 job 번호는 나중에 squeue를 통해 정보를 확인하거나 job을 취소할 때 이용되므로 기록해 놓아야 합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">squeue
</code></pre></td></tr></table>
</div>
</div><p>커맨드를 통해 작업 실행 현황을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">JOBID PARTITION     NAME     USER ST    TIME  NODES NODELIST(REASON)
402     all       testEnv    mjm  R    0:01    1  cpu-compute
</code></pre></td></tr></table>
</div>
</div><p>또는 아래 커맨드를 통해 실시간(1초 단위)으로 작업 실행 현황을 확인할 수 있습니다. <strong>ctrl+c</strong>로 escape 할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">smap -i <span class="m">1</span> 
</code></pre></td></tr></table>
</div>
</div><p>다음 커맨드를 통해 output log, error log파일의 내용을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="o">[</span>your_job-name<span class="o">]</span>.log
cat <span class="o">[</span>your_job-name<span class="o">]</span>.err
</code></pre></td></tr></table>
</div>
</div><p>log 파일의 내용을 다음 커맨드를 통해 실시간으로 확인할 수 있습니다. <strong>ctrl+c</strong>로 escape할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">tail -f <span class="o">[</span>your_job_name<span class="o">]</span>.log
tail -f <span class="o">[</span>your_job_name<span class="o">]</span>.err
</code></pre></td></tr></table>
</div>
</div><p>터미널을 여러 개 띄워 놓고 각각에 <code>smap</code>과 <code>tail</code> 커맨드를 입력하면 편리하게 실행 상황을 모니터링할 수 있습니다.</p>
<p>위 샘플 코드는 약 3분 안에 작업이 완료됩니다. smap에서 작업 목록이 사라진 후 <strong>cat</strong>으로 로그 파일을 열어서</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3">3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4">4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5">5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6">6</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">pandas-1.1.3         | 10.5 MB   |            |   0% 
pandas-1.1.3         | 10.5 MB   | #######1   |  71% 
pandas-1.1.3         | 10.5 MB   | ########## | 100% 
Preparing transaction: ...working... done
Verifying transaction: ...working... done
Executing transaction: ...working... done
</code></pre></td></tr></table>
</div>
</div><p>와 같은 기록이 남아 있으면 conda environment 생성이 완료된 것입니다.</p>
<p>작업이 끝나기 전에 취소하려면 <strong>scancel</strong> 커맨드를 사용합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">scancel <span class="o">[</span>job_number<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="heading"><a hidden class="anchor" aria-hidden="true" href="#heading">#</a></h2>
<p>가상환경을 생성한 후에 패키지를 추가로 설치할 때는 위의 job script에서 가상환경을 삭제하고 다시 만드는 부분</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">CONDA_BIN_PATH/conda env remove --prefix ENV_PATH 
CONDA_BIN_PATH/conda create -y --prefix ENV_PATH <span class="nv">python</span><span class="o">=</span>3.8.12
</code></pre></td></tr></table>
</div>
</div><p>을 삭제하고 아래와 같이 패키지를 설치하는 커맨드를 추가해 준 다음 job을 제출합니다. -y는 설치 중간에 yes/no 를 물을 경우 자동으로 yes를 입력하게 하는 옵션입니다. 설치 중에 컴퓨터를 직접 조작할 수 없기 때문에 꼭 사용해야 하는 옵션입니다. 아래는 <code>pyyaml</code> 패키지를 설치하는 job script 예시입니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="s">``</span><span class="err">`</span><span class="nx">bash</span>
   <span class="err">#</span><span class="p">!</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">bash</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">job</span><span class="o">-</span><span class="nx">name</span><span class="p">=</span><span class="nx">install_package</span> 
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">nodes</span><span class="p">=</span><span class="mi">1</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">time</span><span class="p">=</span><span class="mi">99</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">mem</span><span class="p">=</span><span class="mi">4</span><span class="nx">gb</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">partition</span><span class="p">=</span><span class="nx">all</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">nodelist</span><span class="p">=</span><span class="nx">cpu</span><span class="o">-</span><span class="nx">compute</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="nx">output</span><span class="p">=</span><span class="nx">testEnv</span><span class="p">.</span><span class="nx">log</span>
   <span class="err">#</span><span class="nx">SBATCH</span> <span class="o">--</span><span class="kt">error</span><span class="p">=</span><span class="nx">testEnv</span><span class="p">.</span><span class="nx">err</span>
   <span class="nx">CONDA_BIN_PATH</span><span class="p">=</span><span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">miniconda</span><span class="o">/</span><span class="nx">bin</span>
   <span class="nx">ENV_NAME</span><span class="p">=</span><span class="nx">testEnv</span> 
   <span class="nx">ENV_PATH</span><span class="p">=</span><span class="o">/</span><span class="nx">mnt</span><span class="o">/</span><span class="nx">nas</span><span class="o">/</span><span class="nx">users</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="nx">whoami</span><span class="p">)</span><span class="o">/</span><span class="p">.</span><span class="nx">conda</span><span class="o">/</span><span class="nx">envs</span><span class="o">/</span><span class="err">$</span><span class="nx">ENV_NAME</span> <span class="err">#</span><span class="nx">environment의</span> <span class="nx">경</span>
   <span class="nx">source</span> <span class="err">$</span><span class="nx">CONDA_BIN_PATH</span><span class="o">/</span><span class="nx">activate</span> <span class="err">$</span><span class="nx">ENV_PATH</span> 
   <span class="nx">conda</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">y</span> <span class="nx">pyyaml</span> <span class="err">#</span><span class="nx">설치할</span> <span class="nx">패키지</span> <span class="nx">목록</span><span class="p">.</span> <span class="o">-</span><span class="nx">y는</span> <span class="nx">yes</span><span class="o">/</span><span class="nx">no</span> <span class="nx">question에</span> <span class="nx">yes로</span> <span class="nx">답하도록</span> <span class="nx">함</span><span class="p">.</span> <span class="nx">설치</span> <span class="nx">중에</span> <span class="nx">상호작용이</span> <span class="nx">불가능하므로</span> <span class="o">-</span><span class="nx">y</span> <span class="nx">옵션이</span> <span class="nx">꼭</span> <span class="nx">필요함</span>
</code></pre></td></tr></table>
</div>
</div><p>가상환경 생성 및 패키지 설치 중 일어나는 오류 중 상당수가 Python에서 기본으로 제공하는 패키지를 설치하려 하거나, 설치할 패키지의 이름을 잘못 입력했기 때문에 발생합니다. 예를 들어, 위에서 설치한 <code>pyyaml</code> 패키지는 실제로 Python에서 import할 때는 <code>import yaml</code>로 입력하는데, <code>conda install yaml</code>이라고 job script에 쓸 경우 오류가 발생합니다.</p>
<h2 id="step-5-slrum-batch-script-작성하여-서버에-제출하기">Step 5. Slrum batch script 작성하여 서버에 제출하기<a hidden class="anchor" aria-hidden="true" href="#step-5-slrum-batch-script-작성하여-서버에-제출하기">#</a></h2>
<h3 id="51-python-코드-작성">5.1. Python 코드 작성<a hidden class="anchor" aria-hidden="true" href="#51-python-코드-작성">#</a></h3>
<p>이제 클러스터에서 실행할 Python 코드를 local에서 작성합니다. 코드가 오류 없이 작동하는지 local에서 확인합니다. 그 후 코드 파일을 user home directory에 옮기거나, <code>Visual Studio Code</code>내에서 작성하여 저장합니다.</p>
<p>아래는 tree 기반 boosting 알고리즘인 LightGBM으로 mnist dataset을 분류하는 코드입니다. Boosting round를 10회 수행하고 학습 결과를 csv파일로 저장합니다<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. Batch script를 작성할 때는 알고리즘의 output이 자동으로 저장되지 않으므로 파일로 결과를 저장하는 코드를 포함하는 것이 좋습니다. 단, 콘솔에 출력되는 내용은 output log에 자동으로 기록됩니다. 아래 코드를 <code>python_test_cpu.py</code>로 저장하여 user home directory에 둡니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span><span class="lnt" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a>
</span><span class="lnt" id="17"><a style="outline: none; text-decoration:none; color:inherit" href="#17">17</a>
</span><span class="lnt" id="18"><a style="outline: none; text-decoration:none; color:inherit" href="#18">18</a>
</span><span class="lnt" id="19"><a style="outline: none; text-decoration:none; color:inherit" href="#19">19</a>
</span><span class="lnt" id="20"><a style="outline: none; text-decoration:none; color:inherit" href="#20">20</a>
</span><span class="lnt" id="21"><a style="outline: none; text-decoration:none; color:inherit" href="#21">21</a>
</span><span class="lnt" id="22"><a style="outline: none; text-decoration:none; color:inherit" href="#22">22</a>
</span><span class="lnt" id="23"><a style="outline: none; text-decoration:none; color:inherit" href="#23">23</a>
</span><span class="lnt" id="24"><a style="outline: none; text-decoration:none; color:inherit" href="#24">24</a>
</span><span class="lnt" id="25"><a style="outline: none; text-decoration:none; color:inherit" href="#25">25</a>
</span><span class="lnt" id="26"><a style="outline: none; text-decoration:none; color:inherit" href="#26">26</a>
</span><span class="lnt" id="27"><a style="outline: none; text-decoration:none; color:inherit" href="#27">27</a>
</span><span class="lnt" id="28"><a style="outline: none; text-decoration:none; color:inherit" href="#28">28</a>
</span><span class="lnt" id="29"><a style="outline: none; text-decoration:none; color:inherit" href="#29">29</a>
</span><span class="lnt" id="30"><a style="outline: none; text-decoration:none; color:inherit" href="#30">30</a>
</span><span class="lnt" id="31"><a style="outline: none; text-decoration:none; color:inherit" href="#31">31</a>
</span><span class="lnt" id="32"><a style="outline: none; text-decoration:none; color:inherit" href="#32">32</a>
</span><span class="lnt" id="33"><a style="outline: none; text-decoration:none; color:inherit" href="#33">33</a>
</span><span class="lnt" id="34"><a style="outline: none; text-decoration:none; color:inherit" href="#34">34</a>
</span><span class="lnt" id="35"><a style="outline: none; text-decoration:none; color:inherit" href="#35">35</a>
</span><span class="lnt" id="36"><a style="outline: none; text-decoration:none; color:inherit" href="#36">36</a>
</span><span class="lnt" id="37"><a style="outline: none; text-decoration:none; color:inherit" href="#37">37</a>
</span><span class="lnt" id="38"><a style="outline: none; text-decoration:none; color:inherit" href="#38">38</a>
</span><span class="lnt" id="39"><a style="outline: none; text-decoration:none; color:inherit" href="#39">39</a>
</span><span class="lnt" id="40"><a style="outline: none; text-decoration:none; color:inherit" href="#40">40</a>
</span><span class="lnt" id="41"><a style="outline: none; text-decoration:none; color:inherit" href="#41">41</a>
</span><span class="lnt" id="42"><a style="outline: none; text-decoration:none; color:inherit" href="#42">42</a>
</span><span class="lnt" id="43"><a style="outline: none; text-decoration:none; color:inherit" href="#43">43</a>
</span><span class="lnt" id="44"><a style="outline: none; text-decoration:none; color:inherit" href="#44">44</a>
</span><span class="lnt" id="45"><a style="outline: none; text-decoration:none; color:inherit" href="#45">45</a>
</span><span class="lnt" id="46"><a style="outline: none; text-decoration:none; color:inherit" href="#46">46</a>
</span><span class="lnt" id="47"><a style="outline: none; text-decoration:none; color:inherit" href="#47">47</a>
</span><span class="lnt" id="48"><a style="outline: none; text-decoration:none; color:inherit" href="#48">48</a>
</span><span class="lnt" id="49"><a style="outline: none; text-decoration:none; color:inherit" href="#49">49</a>
</span><span class="lnt" id="50"><a style="outline: none; text-decoration:none; color:inherit" href="#50">50</a>
</span><span class="lnt" id="51"><a style="outline: none; text-decoration:none; color:inherit" href="#51">51</a>
</span><span class="lnt" id="52"><a style="outline: none; text-decoration:none; color:inherit" href="#52">52</a>
</span><span class="lnt" id="53"><a style="outline: none; text-decoration:none; color:inherit" href="#53">53</a>
</span><span class="lnt" id="54"><a style="outline: none; text-decoration:none; color:inherit" href="#54">54</a>
</span><span class="lnt" id="55"><a style="outline: none; text-decoration:none; color:inherit" href="#55">55</a>
</span><span class="lnt" id="56"><a style="outline: none; text-decoration:none; color:inherit" href="#56">56</a>
</span><span class="lnt" id="57"><a style="outline: none; text-decoration:none; color:inherit" href="#57">57</a>
</span><span class="lnt" id="58"><a style="outline: none; text-decoration:none; color:inherit" href="#58">58</a>
</span><span class="lnt" id="59"><a style="outline: none; text-decoration:none; color:inherit" href="#59">59</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span>
<span class="kn">from</span> <span class="nn">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">log_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>


<span class="k">def</span> <span class="nf">lgb</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">mnist</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="s1">&#39;mnist_784&#39;</span><span class="p">)</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">mnist</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mnist</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>



    <span class="n">proba_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))))</span>
    <span class="n">proba_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">))))</span>

    <span class="n">test_score</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_score</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">tr_time</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">sequence</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">tr_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
        <span class="n">test_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)))</span>
        <span class="n">train_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)))</span>
        <span class="n">proba_test</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
        <span class="n">proba_train</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

        <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">ce_train</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ce_test</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">ce_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">proba_test</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">ce_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">proba_train</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;round&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;proba_test.csv&#39;</span><span class="p">,</span> <span class="n">proba_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;round&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;proba_train.csv&#39;</span><span class="p">,</span> <span class="n">proba_train</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;test_score.csv&#39;</span><span class="p">,</span> <span class="n">test_score</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;train_score.csv&#39;</span><span class="p">,</span> <span class="n">train_score</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;ce_test.csv&#39;</span><span class="p">,</span> <span class="n">ce_test</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;ce_train.csv&#39;</span><span class="p">,</span> <span class="n">ce_train</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lgb</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="52-현재-클러스터-자원-사용량-확인">5.2. 현재 클러스터 자원 사용량 확인<a hidden class="anchor" aria-hidden="true" href="#52-현재-클러스터-자원-사용량-확인">#</a></h3>
<p>아래 커맨드를 통해 <code>cpu-compute</code> 노드의 cpu와 RAM 사용 현황을 볼 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sinfo -o <span class="s2">&#34;%n %e %m %a %c %C&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>아래와 같은 결과가 나옵니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">HOSTNAMES FREE_MEM MEMORY AVAIL CPUS CPUS(A/I/O/T)
cpu-compute 105589 128916 up 32 0/32/0/32
gpu-compute 53318 80532 up 16 0/16/0/16
</code></pre></td></tr></table>
</div>
</div><ul>
<li>CPUS의 A/I/O/T는 allocated/idle/other/total을 의미합니다.</li>
<li>자신의 job이 바로 실행되기를 원한다면, Slurm batch script를 작성할 때
<ul>
<li>RAM 용량을 FREE_MEM보다 적게 설정해야 합니다.</li>
<li>CPU 코어 개수를 CPUS idle보다 적게 설정해야 합니다.</li>
</ul>
</li>
<li>현재 가용 자원보다 더 많은 자원을 요구하는 script를 작성하면, job이 바로 실행되지 않습니다. 대기 상태에 있다가 다른 user들의 job이 끝나고 자원이 반환되면 job이 실행됩니다.</li>
</ul>
<h3 id="53-slurm-batch-script-작성">5.3. Slurm batch script 작성<a hidden class="anchor" aria-hidden="true" href="#53-slurm-batch-script-작성">#</a></h3>
<p>앞선 단계에서 만든 해당 conda environment를 activate하고 코드를 실행하는 Slurm batch script를 작성합니다. 클러스터 소개 페이지의 <a href="https://hpc.stat.yonsei.ac.kr/tools/job-configurator.html">slurm job configurator</a>를 사용하면 script를 쉽게 작성할 수 있습니다.</p>
<p><img loading="lazy" src="/img/slurm_config.png" alt="slurm_config"  />
</p>
<ul>
<li>Conda activate에 체크합니다.</li>
<li>빈칸들을 채웁니다. 사용 시간을 넉넉하게 입력할 것을 권장합니다.</li>
<li>Script란에 <strong>python xxx.py</strong>라고 작성합니다. 이는 home directory에 있는 <strong>xxx.py</strong> 파일을 Python으로 실행하라는 의미입니다. Job script를 작성하거나 sbatch 명령어를 사용할 때, visual studio code의 explorer에서 파일명을 마우스 우클릭하고 경로 복사를 사용하면 편리합니다.</li>
<li><strong>Print &amp; Copy</strong> 버튼을 누르면 내용이 클립보드에 복사됩니다.</li>
</ul>
<p>Slurm batch script의 내용은 아래와 같습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span><span class="lnt" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a>
</span><span class="lnt" id="17"><a style="outline: none; text-decoration:none; color:inherit" href="#17">17</a>
</span><span class="lnt" id="18"><a style="outline: none; text-decoration:none; color:inherit" href="#18">18</a>
</span><span class="lnt" id="19"><a style="outline: none; text-decoration:none; color:inherit" href="#19">19</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash 
</span><span class="cp"></span><span class="c1">#</span>
<span class="c1">#SBATCH --job-name=python_test_cpu</span>
<span class="c1">#SBATCH --partition=all</span>
<span class="c1">#SBATCH --account=mjm</span>
<span class="c1">#SBATCH --mem=4gb</span>
<span class="c1">#SBATCH --ntasks=1</span>
<span class="c1">#SBATCH --cpus-per-task=4</span>
<span class="c1">#SBATCH --time=01:00:00</span>
<span class="c1">#SBATCH --output=/mnt/nas/users/mjm/python_test_cpu.log</span>
<span class="c1">#SBATCH --error=/mnt/nas/users/mjm/python_test_cpu.err</span>
<span class="c1">#SBATCH --nodelist=cpu-compute</span>

<span class="nv">CONDA_BIN_PATH</span><span class="o">=</span>/opt/miniconda/bin
<span class="nv">ENV_NAME</span><span class="o">=</span>testEnv
<span class="nv">ENV_PATH</span><span class="o">=</span>/mnt/nas/users/<span class="k">$(</span>whoami<span class="k">)</span>/.conda/envs/<span class="nv">$ENV_NAME</span>
<span class="nb">source</span> <span class="nv">$CONDA_BIN_PATH</span>/activate <span class="nv">$ENV_PATH</span>

python python_test_cpu.py
</code></pre></td></tr></table>
</div>
</div><p><code>python_test_cpu.job</code>이라는 이름으로 클러스터의 user home directory에 저장합니다.</p>
<p>Script 윗부분의 #SBATCH 옵션들의 의미는 다음과 같습니다.</p>
<ul>
<li><strong>—job-name</strong>: 수행할 작업의 이름</li>
<li><strong>—mem</strong>: memory limit</li>
<li><strong>—nodelist</strong>: 작업할 노드의 이름</li>
<li><strong>—ntasks</strong>: 작업의 수</li>
<li><strong>—cpus-per-task</strong>: 각 작업에서 사용할 cpu 코어의 수</li>
<li><strong>—time</strong>: 작업 제한시간</li>
<li><strong>—accoun</strong>t: 해당 작업을 수행하는 계정의 이름</li>
<li><strong>—partition</strong>: group of nodes with specific characteristics</li>
<li><strong>&ndash;nodelist</strong>: 사용할 node의 이름</li>
<li><strong>—output</strong>: 코드 실행 결과 log 파일. 확장자는 out이나 log가 가능합니다.</li>
<li><strong>—error</strong>: 코드 실행 결과 log
error 파일과 log 파일의 파일명과 저장 경로는 원하는 데로 수정할 수 있습니다.
sbatch에 대한 더 자세한 정보는 <a href="https://slurm.schedmd.com/sbatch.html">Slurm 공식 웹페이지</a>를 참조하세요.</li>
</ul>
<h3 id="54-slurm-batch-script-실행">5.4. Slurm batch script 실행<a hidden class="anchor" aria-hidden="true" href="#54-slurm-batch-script-실행">#</a></h3>
<p>Conda environment를 만들 때처럼, <strong>sbatch</strong> 커맨드를 통해 job을 제출합니다. 할당되는 job 번호는 나중에 squeue를 통해 정보를 확인하거나 job을 취소할 때 이용되므로 기록해 놓아야 합니다.</p>
<p>Step 4에서처럼, <code>ctrl+shift+~</code>를 눌러 터미널을 여러 개 띄우고 <strong>smap -i</strong>로 작업 현황을 확인하고, <strong>tail -f xxx.out</strong>, <strong>tail -f xxx.err</strong>으로 콘솔 출력이나 error를 확인합니다. 작업은 4분 정도 걸립니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sbatch python_test_cpu.job
</code></pre></td></tr></table>
</div>
</div><p>현재 작업이 자원을 얼마나 할당받았는지 확인하려면 다음 커맨드를 사용합니다. NumCPUs=4가 코어를 4개 할당받았다는 뜻이고, mem=4G가 RAM을 4gb 할당받았다는 뜻입니다. 이 커맨드는 다른 user가 제출한 job에 대해서도 사용할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">scontrol show job <span class="o">[</span>job number<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span><span class="lnt" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a>
</span><span class="lnt" id="17"><a style="outline: none; text-decoration:none; color:inherit" href="#17">17</a>
</span><span class="lnt" id="18"><a style="outline: none; text-decoration:none; color:inherit" href="#18">18</a>
</span><span class="lnt" id="19"><a style="outline: none; text-decoration:none; color:inherit" href="#19">19</a>
</span><span class="lnt" id="20"><a style="outline: none; text-decoration:none; color:inherit" href="#20">20</a>
</span><span class="lnt" id="21"><a style="outline: none; text-decoration:none; color:inherit" href="#21">21</a>
</span><span class="lnt" id="22"><a style="outline: none; text-decoration:none; color:inherit" href="#22">22</a>
</span><span class="lnt" id="23"><a style="outline: none; text-decoration:none; color:inherit" href="#23">23</a>
</span><span class="lnt" id="24"><a style="outline: none; text-decoration:none; color:inherit" href="#24">24</a>
</span><span class="lnt" id="25"><a style="outline: none; text-decoration:none; color:inherit" href="#25">25</a>
</span><span class="lnt" id="26"><a style="outline: none; text-decoration:none; color:inherit" href="#26">26</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">UserId=mjm(1003) GroupId=mjm(1003) MCS_label=N/A
   Priority=4294901694 Nice=0 Account=mjm QOS=(null)
   JobState=RUNNING Reason=None Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0
   RunTime=00:00:05 TimeLimit=01:00:00 TimeMin=N/A
   SubmitTime=2022-03-17T15:31:01 EligibleTime=2022-03-17T15:31:01
   StartTime=2022-03-17T15:31:01 EndTime=2022-03-17T16:31:01 Deadline=N/A
   PreemptTime=None SuspendTime=None SecsPreSuspend=0
   LastSchedEval=2022-03-17T15:31:01
   Partition=all AllocNode:Sid=proxy:30897
   ReqNodeList=cpu-compute ExcNodeList=(null)
   NodeList=cpu-compute
   BatchHost=cpu-compute
   NumNodes=1 NumCPUs=4 NumTasks=1 CPUs/Task=4 ReqB:S:C:T=0:0:*:*
   TRES=cpu=4,mem=4G,node=1,billing=4
   Socks/Node=* NtasksPerN:B:S:C=0:0:*:* CoreSpec=*
   MinCPUsNode=4 MinMemoryNode=4G MinTmpDiskNode=0
   Features=(null) DelayBoot=00:00:00
   Gres=(null) Reservation=(null)
   OverSubscribe=OK Contiguous=0 Licenses=(null) Network=(null)
   Command=/mnt/nas/users/mjm/python_test_cpu.job
   WorkDir=/mnt/nas/users/mjm
   StdErr=/mnt/nas/users/mjm/python_test_cpu.err
   StdIn=/dev/null
   StdOut=/mnt/nas/users/mjm/python_test_cpu.log
   Power=
</code></pre></td></tr></table>
</div>
</div><p><code>Visual Stuio Code</code>의 file explorer는 실시간으로 변화가 반영되지 않습니다. 새로고침 버튼을 눌러 주면 변화가 반영되고 output 파일이 explorer에 보입니다.</p>
<h2 id="더-알아보기">더 알아보기<a hidden class="anchor" aria-hidden="true" href="#더-알아보기">#</a></h2>
<p><a href="https://ubccr.freshdesk.com/support/solutions/articles/5000688140-submitting-a-slurm-job-script">Submitting a slurm job script</a></p>
<p><a href="https://doc.zih.tu-dresden.de/jobs_and_resources/slurm_examples/">SLRUM Job Examples</a></p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://jstar0525.tistory.com/14">https://jstar0525.tistory.com/14</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://docs.conda.io/projects/conda/en/latest/release-notes.html">https://docs.conda.io/projects/conda/en/latest/release-notes.html</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://www.kaggle.com/samanemami/script-lightgbm-mnist">https://www.kaggle.com/samanemami/script-lightgbm-mnist</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="https://hpc.stat.yonsei.ac.kr/docs/03_how-to-use-cpu-node_r/">
    <span class="title">« Prev Page</span>
    <br>
    <span>3. CPU node 사용법(R)</span>
  </a>
  <a class="next" href="https://hpc.stat.yonsei.ac.kr/docs/01_intro/">
    <span class="title">Next Page »</span>
    <br>
    <span>1. Introduction</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <p align="center">
        <a href="http://bk21-bigdata.yonsei.ac.kr/bbs/page.php?hid=equipment">
        <img width='70%' src='https://hpc.stat.yonsei.ac.kr/images/logo.svg' alt='Yonsei BK logo'>
        </a>
        <br>
    </p>
    <span>&copy; 2022 <a href="https://hpc.stat.yonsei.ac.kr">Chili Pepper</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
