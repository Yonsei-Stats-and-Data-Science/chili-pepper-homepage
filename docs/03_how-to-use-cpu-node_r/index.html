<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>3. CPU node 사용법(R) | Chili Pepper</title>
<meta name="keywords" content="" />
<meta name="description" content="3. CPU node에서 R 코드 실행하기 2번 문서의 Step 1, 2, 3을 먼저 숙지하시기 바랍니다. 이 문서는 그 이후의 내용만을 다룹니다.
1. R 코드 작성 클러스터에서 실행할 R 코드를 local에서 작성합니다. 코드가 문제 없이 실행되는지 먼저 local에서 확인합니다. 그 후 실제로 실행할 코드를 작성하여 클러스터의 user home directory에 옮기거나, Visual Studio Code내에서 작성하여 저장합니다.
R은 cpu-compute에만 설치되어 있습니다. R은 conda environment를 사용하지 않습니다. R 패키지들은 user별 directory가 아닌 NAS 내의 공통 폴더에 저장됩니다.">
<meta name="author" content="Jongmin Mun">
<link rel="canonical" href="https://hpc.stat.yonsei.ac.kr/docs/03_how-to-use-cpu-node_r/" />
<meta name="google-site-verification" content="XYZabc" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css" integrity="sha256-yIlj/i15RiAA/Q&#43;xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://hpc.stat.yonsei.ac.kr/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://hpc.stat.yonsei.ac.kr/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://hpc.stat.yonsei.ac.kr/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://hpc.stat.yonsei.ac.kr/apple-touch-icon.png">
<link rel="mask-icon" href="https://hpc.stat.yonsei.ac.kr/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.91.2" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="3. CPU node 사용법(R)" />
<meta property="og:description" content="3. CPU node에서 R 코드 실행하기 2번 문서의 Step 1, 2, 3을 먼저 숙지하시기 바랍니다. 이 문서는 그 이후의 내용만을 다룹니다.
1. R 코드 작성 클러스터에서 실행할 R 코드를 local에서 작성합니다. 코드가 문제 없이 실행되는지 먼저 local에서 확인합니다. 그 후 실제로 실행할 코드를 작성하여 클러스터의 user home directory에 옮기거나, Visual Studio Code내에서 작성하여 저장합니다.
R은 cpu-compute에만 설치되어 있습니다. R은 conda environment를 사용하지 않습니다. R 패키지들은 user별 directory가 아닌 NAS 내의 공통 폴더에 저장됩니다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hpc.stat.yonsei.ac.kr/docs/03_how-to-use-cpu-node_r/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2022-03-17T13:54:35&#43;09:00" />
<meta property="article:modified_time" content="2022-03-17T13:54:35&#43;09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="3. CPU node 사용법(R)"/>
<meta name="twitter:description" content="3. CPU node에서 R 코드 실행하기 2번 문서의 Step 1, 2, 3을 먼저 숙지하시기 바랍니다. 이 문서는 그 이후의 내용만을 다룹니다.
1. R 코드 작성 클러스터에서 실행할 R 코드를 local에서 작성합니다. 코드가 문제 없이 실행되는지 먼저 local에서 확인합니다. 그 후 실제로 실행할 코드를 작성하여 클러스터의 user home directory에 옮기거나, Visual Studio Code내에서 작성하여 저장합니다.
R은 cpu-compute에만 설치되어 있습니다. R은 conda environment를 사용하지 않습니다. R 패키지들은 user별 directory가 아닌 NAS 내의 공통 폴더에 저장됩니다."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Docs",
      "item": "https://hpc.stat.yonsei.ac.kr/docs/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "3. CPU node 사용법(R)",
      "item": "https://hpc.stat.yonsei.ac.kr/docs/03_how-to-use-cpu-node_r/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "3. CPU node 사용법(R)",
  "name": "3. CPU node 사용법(R)",
  "description": "3. CPU node에서 R 코드 실행하기 2번 문서의 Step 1, 2, 3을 먼저 숙지하시기 바랍니다. 이 문서는 그 이후의 내용만을 다룹니다.\n1. R 코드 작성 클러스터에서 실행할 R 코드를 local에서 작성합니다. 코드가 문제 없이 실행되는지 먼저 local에서 확인합니다. 그 후 실제로 실행할 코드를 작성하여 클러스터의 user home directory에 옮기거나, Visual Studio Code내에서 작성하여 저장합니다.\nR은 cpu-compute에만 설치되어 있습니다. R은 conda environment를 사용하지 않습니다. R 패키지들은 user별 directory가 아닌 NAS 내의 공통 폴더에 저장됩니다.",
  "keywords": [
    
  ],
  "articleBody": "3. CPU node에서 R 코드 실행하기 2번 문서의 Step 1, 2, 3을 먼저 숙지하시기 바랍니다. 이 문서는 그 이후의 내용만을 다룹니다.\n1. R 코드 작성 클러스터에서 실행할 R 코드를 local에서 작성합니다. 코드가 문제 없이 실행되는지 먼저 local에서 확인합니다. 그 후 실제로 실행할 코드를 작성하여 클러스터의 user home directory에 옮기거나, Visual Studio Code내에서 작성하여 저장합니다.\nR은 cpu-compute에만 설치되어 있습니다. R은 conda environment를 사용하지 않습니다. R 패키지들은 user별 directory가 아닌 NAS 내의 공통 폴더에 저장됩니다. 실행할 R 코드를 script로 작성한 다음 Slurm batch script 내에 해당 script를 실행하도록 Rscript xxx.R command를 적어주면 됩니다.\n아래의 샘플 코드는 xgboost와 caret을 설치 및 로드하고 learning과 prediction을 수행한 다음 prediction 결과 plot을 jpeg로 저장하는 코드입니다. Batch script를 작성할 때는 알고리즘의 output이 자동으로 저장되지 않으므로 파일로 결과를 저장하는 코드를 포함하는 것이 좋습니다. 아래 코드를 R_test_cpu.R로 저장하여 user home directory에 둡니다.\n**install.packages()**에서\n force = FALSE 옵션은 이미 설치된 패키지를 또 설치하는 것을 막아줍니다1. INSTALL_opts = c('–no-lock') 옵션은 설치가 이전에 강제로 중단되어서 directory에 락이 걸렸을 때 락을 무시하고 설치하게 합니다2.  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  install.packages(\"xgboost\", force = FALSE, INSTALL_opts = c('--no-lock')) install.packages(\"caret\", force = FALSE, INSTALL_opts = c('--no-lock')) library(xgboost) library(caret) boston = MASS::Boston str(boston) set.seed(12) indexes = createDataPartition(boston$medv, p = .85, list = F) train = boston[indexes, ] test = boston[-indexes, ] train_x = data.matrix(train[, -13]) train_y = train[,13] test_x = data.matrix(test[, -13]) test_y = test[, 13] xgb_train = xgb.DMatrix(data = train_x, label = train_y) xgb_test = xgb.DMatrix(data = test_x, label = test_y) xgbc = xgboost(data = xgb_train, max.depth = 2, nrounds = 50) print(xgbc) pred_y = predict(xgbc, xgb_test) mse = mean((test_y - pred_y)^2) mae = caret::MAE(test_y, pred_y) rmse = caret::RMSE(test_y, pred_y) cat(\"MSE: \", mse, \"MAE: \", mae, \" RMSE: \", rmse) x = 1:length(test_y) jpeg(file=\"R_plot.jpeg\") plot(x, test_y, col = \"red\", type = \"l\") lines(x, pred_y, col = \"blue\", type = \"l\") legend(x = 1, y = 38, legend = c(\"original test_y\", \"predicted test_y\"), col = c(\"red\", \"blue\"), box.lty = 1, cex = 0.8, lty = c(1, 1)) dev.off()   3\n2. 현재 클러스터 자원 사용량 확인 아래 커맨드를 통해 cpu-compute 노드의 cpu와 RAM 사용 현황을 볼 수 있습니다.\n1  sinfo -o \"%n %e %m %a %c %C\"   아래와 같은 결과가 나옵니다.\n1 2 3  HOSTNAMES FREE_MEM MEMORY AVAIL CPUS CPUS(A/I/O/T) cpu-compute 105589 128916 up 32 0/32/0/32 gpu-compute 53318 80532 up 16 0/16/0/16    CPUS의 A/I/O/T는 allocated/idle/other/total을 의미합니다. 자신의 job이 바로 실행되기를 원한다면, Slurm batch script를 작성할 때  RAM 용량을 FREE_MEM보다 적게 설정해야 합니다. CPU 코어 개수를 CPUS idle보다 적게 설정해야 합니다.   현재 가용 자원보다 더 많은 자원을 요구하는 script를 작성하면, job이 바로 실행되지 않습니다. 대기 상태에 있다가 다른 사용자들의 job이 끝나고 자원이 반환되면 job이 실행됩니다.  3. Slurm batch script 작성 작성한 코드를 cpu-compute node에서 실행하는 Slurm batch script를 작성합니다. 클러스터 소개 페이지의 slurm job configurator를 사용하면 script를 쉽게 작성할 수 있습니다.\n Python과 달리 conda environment를 사용하지 않으므로, conda activate에 체크하지 않습니다. 빈칸들을 채웁니다. Script란에 Rscript xxx.R라고 작성합니다. 이는 home directory에 있는 xxx.R 파일을 R로 실행하라는 의미입니다. Print \u0026 Copy 버튼을 누르면 내용이 클립보드에 복사됩니다.  R_test_cpu.job이라는 이름으로 클러스터의 user home directory에 저장합니다.\nConfigurator로 생성한 Slurm batch script의 내용은 아래와 같습니다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  #!/bin/bash # #SBATCH --job-name=R_test_cpu #SBATCH --partition=all #SBATCH --account=mjm #SBATCH --mem=16gb #SBATCH --ntasks=1 #SBATCH --cpus-per-task=4 #SBATCH --time=00:50:00 #SBATCH --output=/mnt/nas/users/mjm/R_test_cpu.log #SBATCH --error=/mnt/nas/users/mjm/R_test_cpu.err #SBATCH --nodelist=cpu-compute Rscript R_test_cpu.R   Script 윗부분의 #SBATCH 옵션들의 의미는 다음과 같습니다.\n —job-name: 수행할 작업의 이름 —mem: memory limit —nodelist: 작업할 노드의 이름 —ntasks: 작업의 수 —cpus-per-task: 각 작업에서 사용할 cpu 코어의 수 —time: 작업 제한시간 —account: 해당 작업을 수행하는 계정의 이름 —partition: group of nodes with specific characteristics –nodelist: 사용할 node의 이름 —output: 코드 실행 결과 log 파일. 확장자는 out이나 log가 가능합니다. —error: 코드 실행 결과 log  sbatch에 대한 더 자세한 정보는 Slurm 공식 웹페이지를 참조하세요.\n4. Slurm batch script 실행 sbatch 커맨드를 통해 job을 제출합니다. 2번 문서의 Step 4에서처럼, ctrl+shift+~를 눌러 터미널을 여러 개 띄우고 smap -i로 작업 현황을 확인하고, tail -f xxx.out, tail -f xxx.err으로 콘솔 출력이나 error를 확인합니다. 작업은 5분 이내에 끝납니다.\n1  sbatch R_test_cpu.job   더 알아보기 Submitting a slurm job script\nSLRUM Job Examples\nReferences   https://stat.ethz.ch/pipermail/r-help/2010-May/239492.html ↩︎\n https://github.com/lumiamitie/TIL/blob/master/rstudy/package_lock.md ↩︎\n https://www.datatechnotes.com/2020/08/regression-example-with-xgboost-in-r.html ↩︎\n   ",
  "wordCount" : "702",
  "inLanguage": "en",
  "datePublished": "2022-03-17T13:54:35+09:00",
  "dateModified": "2022-03-17T13:54:35+09:00",
  "author":{
    "@type": "Person",
    "name": "Jongmin Mun"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://hpc.stat.yonsei.ac.kr/docs/03_how-to-use-cpu-node_r/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chili Pepper",
    "logo": {
      "@type": "ImageObject",
      "url": "https://hpc.stat.yonsei.ac.kr/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://hpc.stat.yonsei.ac.kr" accesskey="h" title="Chili Pepper (Alt + H)">Chili Pepper</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://hpc.stat.yonsei.ac.kr/docs/" title="Docs">
                    <span>Docs</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://hpc.stat.yonsei.ac.kr">Home</a>&nbsp;»&nbsp;<a href="https://hpc.stat.yonsei.ac.kr/docs/">Docs</a></div>
    <h1 class="post-title">
      3. CPU node 사용법(R)
    </h1>
    <div class="post-meta"><span title='2022-03-17 13:54:35 +0900 +0900'>March 17, 2022</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Jongmin Mun

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#3-cpu-node%ec%97%90%ec%84%9c-r-%ec%bd%94%eb%93%9c-%ec%8b%a4%ed%96%89%ed%95%98%ea%b8%b0" aria-label="3. CPU node에서 R 코드 실행하기">3. CPU node에서 R 코드 실행하기</a><ul>
                        <ul>
                        
                <li>
                    <a href="#1-r-%ec%bd%94%eb%93%9c-%ec%9e%91%ec%84%b1" aria-label="1. R 코드 작성">1. R 코드 작성</a></li>
                <li>
                    <a href="#2-%ed%98%84%ec%9e%ac-%ed%81%b4%eb%9f%ac%ec%8a%a4%ed%84%b0-%ec%9e%90%ec%9b%90-%ec%82%ac%ec%9a%a9%eb%9f%89-%ed%99%95%ec%9d%b8" aria-label="2. 현재 클러스터 자원 사용량 확인">2. 현재 클러스터 자원 사용량 확인</a></li>
                <li>
                    <a href="#3-slurm-batch-script-%ec%9e%91%ec%84%b1" aria-label="3. Slurm batch script 작성">3. Slurm batch script 작성</a></li>
                <li>
                    <a href="#4-slurm-batch-script-%ec%8b%a4%ed%96%89" aria-label="4. Slurm batch script 실행">4. Slurm batch script 실행</a></li></ul>
                    
                <li>
                    <a href="#%eb%8d%94-%ec%95%8c%ec%95%84%eb%b3%b4%ea%b8%b0" aria-label="더 알아보기">더 알아보기</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="3-cpu-node에서-r-코드-실행하기">3. CPU node에서 R 코드 실행하기<a hidden class="anchor" aria-hidden="true" href="#3-cpu-node에서-r-코드-실행하기">#</a></h1>
<p>2번 문서의 Step 1, 2, 3을 먼저 숙지하시기 바랍니다. 이 문서는 그 이후의 내용만을 다룹니다.</p>
<h3 id="1-r-코드-작성">1. R 코드 작성<a hidden class="anchor" aria-hidden="true" href="#1-r-코드-작성">#</a></h3>
<p>클러스터에서 실행할 <code>R</code> 코드를 local에서 작성합니다. 코드가 문제 없이 실행되는지 먼저 local에서 확인합니다. 그 후 실제로 실행할 코드를 작성하여 클러스터의 user home directory에 옮기거나, <code>Visual Studio Code</code>내에서 작성하여 저장합니다.</p>
<p><code>R</code>은 <code>cpu-compute</code>에만 설치되어 있습니다. <code>R</code>은 conda environment를 사용하지 않습니다. <code>R</code> 패키지들은 user별 directory가 아닌 NAS 내의 공통 폴더에 저장됩니다. 실행할 <code>R</code> 코드를 script로 작성한 다음 Slurm batch script 내에 해당 script를 실행하도록 <strong>Rscript xxx.R</strong> command를 적어주면 됩니다.</p>
<p>아래의 샘플 코드는 <code>xgboost</code>와 <code>caret</code>을 설치 및 로드하고 learning과 prediction을 수행한 다음 prediction 결과 plot을 jpeg로 저장하는 코드입니다. Batch script를 작성할 때는 알고리즘의 output이 자동으로 저장되지 않으므로 파일로 결과를 저장하는 코드를 포함하는 것이 좋습니다. 아래 코드를 <code>R_test_cpu.R</code>로 저장하여 user home directory에 둡니다.</p>
<p>**install.packages()**에서</p>
<ul>
<li><strong>force = FALSE</strong> 옵션은 이미 설치된 패키지를 또 설치하는 것을 막아줍니다<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</li>
<li><strong>INSTALL_opts = c('&ndash;no-lock')</strong> 옵션은 설치가 이전에 강제로 중단되어서 directory에 락이 걸렸을 때 락을 무시하고 설치하게 합니다<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span><span class="lnt" id="15"><a style="outline: none; text-decoration:none; color:inherit" href="#15">15</a>
</span><span class="lnt" id="16"><a style="outline: none; text-decoration:none; color:inherit" href="#16">16</a>
</span><span class="lnt" id="17"><a style="outline: none; text-decoration:none; color:inherit" href="#17">17</a>
</span><span class="lnt" id="18"><a style="outline: none; text-decoration:none; color:inherit" href="#18">18</a>
</span><span class="lnt" id="19"><a style="outline: none; text-decoration:none; color:inherit" href="#19">19</a>
</span><span class="lnt" id="20"><a style="outline: none; text-decoration:none; color:inherit" href="#20">20</a>
</span><span class="lnt" id="21"><a style="outline: none; text-decoration:none; color:inherit" href="#21">21</a>
</span><span class="lnt" id="22"><a style="outline: none; text-decoration:none; color:inherit" href="#22">22</a>
</span><span class="lnt" id="23"><a style="outline: none; text-decoration:none; color:inherit" href="#23">23</a>
</span><span class="lnt" id="24"><a style="outline: none; text-decoration:none; color:inherit" href="#24">24</a>
</span><span class="lnt" id="25"><a style="outline: none; text-decoration:none; color:inherit" href="#25">25</a>
</span><span class="lnt" id="26"><a style="outline: none; text-decoration:none; color:inherit" href="#26">26</a>
</span><span class="lnt" id="27"><a style="outline: none; text-decoration:none; color:inherit" href="#27">27</a>
</span><span class="lnt" id="28"><a style="outline: none; text-decoration:none; color:inherit" href="#28">28</a>
</span><span class="lnt" id="29"><a style="outline: none; text-decoration:none; color:inherit" href="#29">29</a>
</span><span class="lnt" id="30"><a style="outline: none; text-decoration:none; color:inherit" href="#30">30</a>
</span><span class="lnt" id="31"><a style="outline: none; text-decoration:none; color:inherit" href="#31">31</a>
</span><span class="lnt" id="32"><a style="outline: none; text-decoration:none; color:inherit" href="#32">32</a>
</span><span class="lnt" id="33"><a style="outline: none; text-decoration:none; color:inherit" href="#33">33</a>
</span><span class="lnt" id="34"><a style="outline: none; text-decoration:none; color:inherit" href="#34">34</a>
</span><span class="lnt" id="35"><a style="outline: none; text-decoration:none; color:inherit" href="#35">35</a>
</span><span class="lnt" id="36"><a style="outline: none; text-decoration:none; color:inherit" href="#36">36</a>
</span><span class="lnt" id="37"><a style="outline: none; text-decoration:none; color:inherit" href="#37">37</a>
</span><span class="lnt" id="38"><a style="outline: none; text-decoration:none; color:inherit" href="#38">38</a>
</span><span class="lnt" id="39"><a style="outline: none; text-decoration:none; color:inherit" href="#39">39</a>
</span><span class="lnt" id="40"><a style="outline: none; text-decoration:none; color:inherit" href="#40">40</a>
</span><span class="lnt" id="41"><a style="outline: none; text-decoration:none; color:inherit" href="#41">41</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-R" data-lang="R"><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#34;xgboost&#34;</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">INSTALL_opts</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;--no-lock&#39;</span><span class="p">))</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="s">&#34;caret&#34;</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">INSTALL_opts</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;--no-lock&#39;</span><span class="p">))</span>

<span class="nf">library</span><span class="p">(</span><span class="n">xgboost</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span>

<span class="n">boston</span> <span class="o">=</span> <span class="n">MASS</span><span class="o">::</span><span class="n">Boston</span>
<span class="nf">str</span><span class="p">(</span><span class="n">boston</span><span class="p">)</span>

<span class="nf">set.seed</span><span class="p">(</span><span class="m">12</span><span class="p">)</span>
<span class="n">indexes</span> <span class="o">=</span> <span class="nf">createDataPartition</span><span class="p">(</span><span class="n">boston</span><span class="o">$</span><span class="n">medv</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="m">.85</span><span class="p">,</span> <span class="n">list</span> <span class="o">=</span> <span class="bp">F</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">boston[indexes</span><span class="p">,</span> <span class="n">]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">boston[</span><span class="o">-</span><span class="n">indexes</span><span class="p">,</span> <span class="n">]</span>

<span class="n">train_x</span> <span class="o">=</span> <span class="nf">data.matrix</span><span class="p">(</span><span class="n">train[</span><span class="p">,</span> <span class="m">-13</span><span class="n">]</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">train[</span><span class="p">,</span><span class="m">13</span><span class="n">]</span>

<span class="n">test_x</span> <span class="o">=</span> <span class="nf">data.matrix</span><span class="p">(</span><span class="n">test[</span><span class="p">,</span> <span class="m">-13</span><span class="n">]</span><span class="p">)</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">test[</span><span class="p">,</span> <span class="m">13</span><span class="n">]</span>

<span class="n">xgb_train</span> <span class="o">=</span> <span class="nf">xgb.DMatrix</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">train_y</span><span class="p">)</span>
<span class="n">xgb_test</span> <span class="o">=</span> <span class="nf">xgb.DMatrix</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">test_y</span><span class="p">)</span>

<span class="n">xgbc</span> <span class="o">=</span> <span class="nf">xgboost</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">xgb_train</span><span class="p">,</span> <span class="n">max.depth</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">nrounds</span> <span class="o">=</span> <span class="m">50</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">xgbc</span><span class="p">)</span>

<span class="n">pred_y</span> <span class="o">=</span> <span class="nf">predict</span><span class="p">(</span><span class="n">xgbc</span><span class="p">,</span> <span class="n">xgb_test</span><span class="p">)</span>

<span class="n">mse</span> <span class="o">=</span> <span class="nf">mean</span><span class="p">((</span><span class="n">test_y</span> <span class="o">-</span> <span class="n">pred_y</span><span class="p">)</span><span class="n">^2</span><span class="p">)</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">caret</span><span class="o">::</span><span class="nf">MAE</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">pred_y</span><span class="p">)</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">caret</span><span class="o">::</span><span class="nf">RMSE</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">pred_y</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&#34;MSE: &#34;</span><span class="p">,</span> <span class="n">mse</span><span class="p">,</span> <span class="s">&#34;MAE: &#34;</span><span class="p">,</span> <span class="n">mae</span><span class="p">,</span> <span class="s">&#34; RMSE: &#34;</span><span class="p">,</span> <span class="n">rmse</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">test_y</span><span class="p">)</span>
<span class="nf">jpeg</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s">&#34;R_plot.jpeg&#34;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#34;red&#34;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&#34;l&#34;</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pred_y</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#34;blue&#34;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&#34;l&#34;</span><span class="p">)</span>
<span class="nf">legend</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">38</span><span class="p">,</span>  <span class="n">legend</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;original test_y&#34;</span><span class="p">,</span> <span class="s">&#34;predicted test_y&#34;</span><span class="p">),</span> 
       <span class="n">col</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;red&#34;</span><span class="p">,</span> <span class="s">&#34;blue&#34;</span><span class="p">),</span> <span class="n">box.lty</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">cex</span> <span class="o">=</span> <span class="m">0.8</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">))</span>
<span class="nf">dev.off</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<h3 id="2-현재-클러스터-자원-사용량-확인">2. 현재 클러스터 자원 사용량 확인<a hidden class="anchor" aria-hidden="true" href="#2-현재-클러스터-자원-사용량-확인">#</a></h3>
<p>아래 커맨드를 통해 <code>cpu-compute</code> 노드의 cpu와 RAM 사용 현황을 볼 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sinfo -o <span class="s2">&#34;%n %e %m %a %c %C&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>아래와 같은 결과가 나옵니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2">2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">HOSTNAMES FREE_MEM MEMORY AVAIL CPUS CPUS(A/I/O/T)
cpu-compute 105589 128916 up 32 0/32/0/32
gpu-compute 53318 80532 up 16 0/16/0/16
</code></pre></td></tr></table>
</div>
</div><ul>
<li>CPUS의 A/I/O/T는 allocated/idle/other/total을 의미합니다.</li>
<li>자신의 job이 바로 실행되기를 원한다면, Slurm batch script를 작성할 때
<ul>
<li>RAM 용량을 FREE_MEM보다 적게 설정해야 합니다.</li>
<li>CPU 코어 개수를 CPUS idle보다 적게 설정해야 합니다.</li>
</ul>
</li>
<li>현재 가용 자원보다 더 많은 자원을 요구하는 script를 작성하면, job이 바로 실행되지 않습니다. 대기 상태에 있다가 다른 사용자들의 job이 끝나고 자원이 반환되면 job이 실행됩니다.</li>
</ul>
<h3 id="3-slurm-batch-script-작성">3. Slurm batch script 작성<a hidden class="anchor" aria-hidden="true" href="#3-slurm-batch-script-작성">#</a></h3>
<p>작성한 코드를 <code>cpu-compute</code> node에서 실행하는 Slurm batch script를 작성합니다. 클러스터 소개 페이지의 <a href="https://hpc.stat.yonsei.ac.kr/tools/job-configurator.html">slurm job configurator</a>를 사용하면 script를 쉽게 작성할 수 있습니다.</p>
<p><img loading="lazy" src="/img/R_slurm_config.png" alt="slurm_config"  />
</p>
<ul>
<li><code>Python</code>과 달리 conda environment를 사용하지 않으므로, conda activate에 체크하지 않습니다.</li>
<li>빈칸들을 채웁니다.</li>
<li>Script란에 <strong>Rscript xxx.R</strong>라고 작성합니다. 이는 home directory에 있는 <strong>xxx.R</strong> 파일을 <code>R</code>로 실행하라는 의미입니다.</li>
<li><strong>Print &amp; Copy</strong> 버튼을 누르면 내용이 클립보드에 복사됩니다.</li>
</ul>
<p><code>R_test_cpu.job</code>이라는 이름으로 클러스터의 user home directory에 저장합니다.</p>
<p>Configurator로 생성한 Slurm batch script의 내용은 아래와 같습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1"> 1</a>
</span><span class="lnt" id="2"><a style="outline: none; text-decoration:none; color:inherit" href="#2"> 2</a>
</span><span class="lnt" id="3"><a style="outline: none; text-decoration:none; color:inherit" href="#3"> 3</a>
</span><span class="lnt" id="4"><a style="outline: none; text-decoration:none; color:inherit" href="#4"> 4</a>
</span><span class="lnt" id="5"><a style="outline: none; text-decoration:none; color:inherit" href="#5"> 5</a>
</span><span class="lnt" id="6"><a style="outline: none; text-decoration:none; color:inherit" href="#6"> 6</a>
</span><span class="lnt" id="7"><a style="outline: none; text-decoration:none; color:inherit" href="#7"> 7</a>
</span><span class="lnt" id="8"><a style="outline: none; text-decoration:none; color:inherit" href="#8"> 8</a>
</span><span class="lnt" id="9"><a style="outline: none; text-decoration:none; color:inherit" href="#9"> 9</a>
</span><span class="lnt" id="10"><a style="outline: none; text-decoration:none; color:inherit" href="#10">10</a>
</span><span class="lnt" id="11"><a style="outline: none; text-decoration:none; color:inherit" href="#11">11</a>
</span><span class="lnt" id="12"><a style="outline: none; text-decoration:none; color:inherit" href="#12">12</a>
</span><span class="lnt" id="13"><a style="outline: none; text-decoration:none; color:inherit" href="#13">13</a>
</span><span class="lnt" id="14"><a style="outline: none; text-decoration:none; color:inherit" href="#14">14</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash 
</span><span class="cp"></span><span class="c1">#</span>
<span class="c1">#SBATCH --job-name=R_test_cpu</span>
<span class="c1">#SBATCH --partition=all</span>
<span class="c1">#SBATCH --account=mjm</span>
<span class="c1">#SBATCH --mem=16gb</span>
<span class="c1">#SBATCH --ntasks=1</span>
<span class="c1">#SBATCH --cpus-per-task=4</span>
<span class="c1">#SBATCH --time=00:50:00</span>
<span class="c1">#SBATCH --output=/mnt/nas/users/mjm/R_test_cpu.log</span>
<span class="c1">#SBATCH --error=/mnt/nas/users/mjm/R_test_cpu.err</span>
<span class="c1">#SBATCH --nodelist=cpu-compute</span>

Rscript R_test_cpu.R
</code></pre></td></tr></table>
</div>
</div><p>Script 윗부분의 #SBATCH 옵션들의 의미는 다음과 같습니다.</p>
<ul>
<li><strong>—job-name</strong>: 수행할 작업의 이름</li>
<li><strong>—mem</strong>: memory limit</li>
<li><strong>—nodelist</strong>: 작업할 노드의 이름</li>
<li><strong>—ntasks</strong>: 작업의 수</li>
<li><strong>—cpus-per-task</strong>: 각 작업에서 사용할 cpu 코어의 수</li>
<li><strong>—time</strong>: 작업 제한시간</li>
<li><strong>—accoun</strong>t: 해당 작업을 수행하는 계정의 이름</li>
<li><strong>—partition</strong>: group of nodes with specific characteristics</li>
<li><strong>&ndash;nodelist</strong>: 사용할 node의 이름</li>
<li><strong>—output</strong>: 코드 실행 결과 log 파일. 확장자는 out이나 log가 가능합니다.</li>
<li><strong>—error</strong>: 코드 실행 결과 log</li>
</ul>
<p>sbatch에 대한 더 자세한 정보는 <a href="https://slurm.schedmd.com/sbatch.html">Slurm 공식 웹페이지</a>를 참조하세요.</p>
<h3 id="4-slurm-batch-script-실행">4. Slurm batch script 실행<a hidden class="anchor" aria-hidden="true" href="#4-slurm-batch-script-실행">#</a></h3>
<p><strong>sbatch</strong> 커맨드를 통해 job을 제출합니다. 2번 문서의 Step 4에서처럼, <code>ctrl+shift+~</code>를 눌러 터미널을 여러 개 띄우고 <strong>smap -i</strong>로 작업 현황을 확인하고, <strong>tail -f xxx.out</strong>, <strong>tail -f xxx.err</strong>으로 콘솔 출력이나 error를 확인합니다. 작업은 5분 이내에 끝납니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a style="outline: none; text-decoration:none; color:inherit" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sbatch R_test_cpu.job
</code></pre></td></tr></table>
</div>
</div><h2 id="더-알아보기">더 알아보기<a hidden class="anchor" aria-hidden="true" href="#더-알아보기">#</a></h2>
<p><a href="https://ubccr.freshdesk.com/support/solutions/articles/5000688140-submitting-a-slurm-job-script">Submitting a slurm job script</a></p>
<p><a href="https://doc.zih.tu-dresden.de/jobs_and_resources/slurm_examples/">SLRUM Job Examples</a></p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://stat.ethz.ch/pipermail/r-help/2010-May/239492.html">https://stat.ethz.ch/pipermail/r-help/2010-May/239492.html</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://github.com/lumiamitie/TIL/blob/master/rstudy/package_lock.md">https://github.com/lumiamitie/TIL/blob/master/rstudy/package_lock.md</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://www.datatechnotes.com/2020/08/regression-example-with-xgboost-in-r.html">https://www.datatechnotes.com/2020/08/regression-example-with-xgboost-in-r.html</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="https://hpc.stat.yonsei.ac.kr/docs/04_how-to-use-gpu-node-for-slurm/">
    <span class="title">« Prev Page</span>
    <br>
    <span>4. GPU node 사용법(Python)</span>
  </a>
  <a class="next" href="https://hpc.stat.yonsei.ac.kr/docs/01_intro/">
    <span class="title">Next Page »</span>
    <br>
    <span>1. Introduction</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <p align="center">
        <a href="http://bk21-bigdata.yonsei.ac.kr/bbs/page.php?hid=equipment">
        <img width='70%' src='https://hpc.stat.yonsei.ac.kr/images/logo.svg' alt='Yonsei BK logo'>
        </a>
        <br>
    </p>
    <span>&copy; 2022 <a href="https://hpc.stat.yonsei.ac.kr">Chili Pepper</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
